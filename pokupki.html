<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />

  <!-- ИКОНКИ -->
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <title>Покупки</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      color: #222;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      background: #ffffff;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 16px;
      background: #4a90e2;
      color: white;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
    }

    header p {
      margin: 4px 0 0;
      font-size: 13px;
      opacity: 0.9;
    }

    .input-block {
      padding: 12px 16px;
      border-bottom: 1px solid #eee;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .row {
      display: flex;
      gap: 8px;
    }

    input[type="text"] {
      flex: 1;
      padding: 8px 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
    }

    input[type="text"]:focus {
      border-color: #4a90e2;
    }

    button {
      border-radius: 8px;
      border: none;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-add {
      background: #4a90e2;
      color: white;
    }

    .btn-add:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .btn-mic {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-mic.active {
      background: #ffecb5;
      border-color: #ffdd57;
    }

    .mic-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #dc3545;
      animation: blink 1s infinite;
    }

    .btn-mic:not(.active) .mic-dot {
      animation: none;
    }

    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.2; }
      100% { opacity: 1; }
    }

    .status {
      font-size: 12px;
      color: #666;
    }

    .list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0 16px;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      border-bottom: 1px solid #eee;
      gap: 10px;
    }

    li .name {
      flex: 1;
      font-size: 16px;
    }

    li.bought .name {
      text-decoration: line-through;
      color: #999;
    }

    .checkbox {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid #4a90e2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .checkbox.checked {
      background: #4a90e2;
      color: white;
    }

    .btn-delete {
      background: transparent;
      color: #ccc;
      font-size: 18px;
      padding: 4px 6px;
    }

    .btn-delete:hover {
      color: #999;
    }

    .footer-buttons {
      padding: 8px 16px 12px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 8px;
      background: #fafafa;
    }

    .btn-clear-bought {
      background: #f8d7da;
      color: #721c24;
    }

    .btn-clear-all {
      background: #e2e3e5;
      color: #383d41;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>Список покупок</h1>
    <p>Добавляй продукты вручную или голосом. Список хранится только у тебя на телефоне.</p>
  </header>

  <div class="input-block">
    <div class="row">
      <input id="item-input" type="text" placeholder="Например: молоко хлеб картошка" />
      <button id="add-btn" class="btn-add" disabled>Добавить</button>
    </div>
    <div class="row">
      <button id="mic-btn" class="btn-mic" style="display:none;">
        <span class="mic-dot"></span>
        <span class="mic-text">Диктовать</span>
      </button>
      <span id="status" class="status"></span>
    </div>
  </div>

  <div class="list">
    <ul id="items-list"></ul>
  </div>

  <div class="footer-buttons">
    <button id="clear-bought-btn" class="btn-clear-bought">Очистить купленные</button>
    <button id="clear-all-btn" class="btn-clear-all">Очистить всё</button>
  </div>
</div>

<script>
  const STORAGE_KEY = 'pokupki-items-v1';
  let items = [];

  function loadItems() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        items = [];
        return;
      }
      items = JSON.parse(raw);
      if (!Array.isArray(items)) items = [];
    } catch (e) {
      items = [];
    }
  }

  function saveItems() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
    } catch (e) {}
  }

  // Разбиваем строку на товары
  function splitToItems(text) {
    if (!text) return [];

    let normalized = text.toLowerCase();

    normalized = normalized
      .replace(/новая строка/g, '\n')
      .replace(/следующая строка/g, '\n')
      .replace(/следующий пункт/g, '\n')
      .replace(/следующий/g, '\n')
      .replace(/enter/g, '\n');

    // убираем точки/знаки, чтобы "мука." стало "мука"
    normalized = normalized.replace(/[.!?]/g, ' ');

    // сначала — по нормальным разделителям
    let parts = normalized
      .split(/[,;\n]/)
      .map(p => p.trim())
      .filter(p => p.length > 0);

    // если получилось мало — по словам
    if (parts.length <= 1) {
      parts = normalized
        .split(/\s+/)
        .map(p => p.trim())
        .filter(p => p.length > 0);
    }

    return parts;
  }

  function addItemsFromText(text) {
    const parts = splitToItems(text);
    if (parts.length === 0) return;

    for (const name of parts) {
      items.push({
        id: Date.now().toString() + Math.random().toString(16).slice(2),
        name,
        bought: false
      });
    }
    saveItems();
    renderList();
  }

  function toggleItem(id) {
    items = items.map(item =>
      item.id === id ? { ...item, bought: !item.bought } : item
    );
    saveItems();
    renderList();
  }

  function deleteItem(id) {
    items = items.filter(item => item.id !== id);
    saveItems();
    renderList();
  }

  function clearBought() {
    items = items.filter(item => !item.bought);
    saveItems();
    renderList();
  }

  function clearAll() {
    if (confirm('Точно удалить весь список?')) {
      items = [];
      saveItems();
      renderList();
    }
  }

  function renderList() {
    const listEl = document.getElementById('items-list');
    listEl.innerHTML = '';

    if (items.length === 0) {
      const li = document.createElement('li');
      li.innerHTML = '<span class="name" style="color:#999;">Список пуст</span>';
      listEl.appendChild(li);
      return;
    }

    items.forEach(item => {
      const li = document.createElement('li');
      if (item.bought) li.classList.add('bought');

      const checkbox = document.createElement('div');
      checkbox.className = 'checkbox' + (item.bought ? ' checked' : '');
      checkbox.innerHTML = item.bought ? '✓' : '';
      checkbox.addEventListener('click', () => toggleItem(item.id));

      const nameSpan = document.createElement('span');
      nameSpan.className = 'name';
      nameSpan.textContent = item.name;
      nameSpan.addEventListener('click', () => toggleItem(item.id));

      const delBtn = document.createElement('button');
      delBtn.className = 'btn-delete';
      delBtn.innerHTML = '✕';
      delBtn.addEventListener('click', () => deleteItem(item.id));

      li.appendChild(checkbox);
      li.appendChild(nameSpan);
      li.appendChild(delBtn);
      listEl.appendChild(li);
    });
  }

  // РАСПОЗНАВАНИЕ РЕЧИ + ЖИВОЙ ТЕКСТ
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;
  let isListening = false;
  let currentTranscript = '';

  function initSpeech() {
    const micBtn = document.getElementById('mic-btn');
    const statusEl = document.getElementById('status');

    if (!SpeechRecognition) {
      micBtn.style.display = 'none';
      statusEl.textContent = 'Можно диктовать через микрофон на клавиатуре.';
      return;
    }

    recognition = new SpeechRecognition();
    recognition.lang = 'ru-RU';
    recognition.interimResults = true;   // показываем текст во время речи
    recognition.maxAlternatives = 1;

    micBtn.style.display = 'inline-flex';

    recognition.onstart = () => {
      isListening = true;
      currentTranscript = '';
      micBtn.classList.add('active');
      document.querySelector('.mic-text').textContent = 'Слушаю...';
      statusEl.textContent = 'Говори: "колбаса хлеб сыр мука"...';
    };

    recognition.onresult = (event) => {
      let text = '';
      for (let i = 0; i < event.results.length; i++) {
        text += event.results[i][0].transcript + ' ';
        if (event.results[i].isFinal) {
          currentTranscript = text;
        }
      }
      statusEl.textContent = 'Распознаю: ' + text.trim();
    };

    recognition.onerror = (event) => {
      statusEl.textContent = 'Ошибка распознавания: ' + event.error;
    };

    recognition.onend = () => {
      micBtn.classList.remove('active');
      document.querySelector('.mic-text').textContent = 'Диктовать';
      isListening = false;

      const finalText = (currentTranscript || '').trim();
      if (finalText.length > 0) {
        addItemsFromText(finalText);
        statusEl.textContent = 'Добавлено: ' + finalText;
      } else {
        statusEl.textContent = 'Ничего не распознано.';
      }
    };

    micBtn.addEventListener('click', () => {
      if (!recognition) return;
      if (!isListening) {
        try { recognition.start(); } catch (e) {}
      } else {
        recognition.stop();
      }
    });
  }

  window.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('item-input');
    const addBtn = document.getElementById('add-btn');
    const clearBoughtBtn = document.getElementById('clear-bought-btn');
    const clearAllBtn = document.getElementById('clear-all-btn');

    loadItems();
    renderList();
    initSpeech();

    function updateAddButtonState() {
      const hasText = input.value.trim().length > 0;
      addBtn.disabled = !hasText;
    }

    input.addEventListener('input', updateAddButtonState);

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (!addBtn.disabled) {
          addItemsFromText(input.value);
          input.value = '';
          updateAddButtonState();
        }
      }
    });

    addBtn.addEventListener('click', () => {
      addItemsFromText(input.value);
      input.value = '';
      updateAddButtonState();
    });

    clearBoughtBtn.addEventListener('click', clearBought);
    clearAllBtn.addEventListener('click', clearAll);
  });
</script>
</body>
</html>
