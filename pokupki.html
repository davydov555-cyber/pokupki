<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shopping App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ICON -->
  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      color: #222;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      background: #ffffff;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 16px;
      background: #4a90e2;
      color: white;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
    }

    header p {
      margin: 4px 0 0;
      font-size: 13px;
      opacity: 0.9;
    }

    .input-block {
      padding: 12px 16px 8px;
      border-bottom: 1px solid #eee;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .row {
      display: flex;
      gap: 8px;
    }

    input[type="text"] {
      flex: 1;
      padding: 8px 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
    }

    button {
      border-radius: 8px;
      border: none;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-primary {
      background: #4a90e2;
      color: white;
    }

    .list {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 20px;
    }

    ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    li {
      display: flex;
      padding: 10px 16px;
      align-items: center;
      border-bottom: 1px solid #eee;
      gap: 10px;
    }

    .checkbox {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid #4a90e2;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .checkbox.checked {
      background: #4a90e2;
      color: white;
    }

    .name {
      flex: 1;
      font-size: 16px;
    }

    li.bought .name {
      text-decoration: line-through;
      color: #aaa;
    }

    .meta {
      font-size: 11px;
      color: #777;
    }

    .btn-delete {
      font-size: 18px;
      background: transparent;
      color: #ccc;
      cursor: pointer;
    }

    .footer-buttons {
      display: flex;
      gap: 8px;
      padding: 10px 16px;
      border-top: 1px solid #eee;
      background: #fafafa;
    }

    .btn-clear-bought {
      background: #f8d7da;
      color: #721c24;
    }

    .btn-clear-all {
      background: #e2e3e5;
      color: #383d41;
    }

    .family-info {
      padding: 8px 16px;
      background: #fafafa;
      font-size: 12px;
      color: #444;
    }

    .family-code-box {
      display: inline-block;
      padding: 3px 7px;
      background: #eef3ff;
      border: 1px dashed #4a90e2;
      border-radius: 6px;
      font-weight: bold;
    }

    /* ONBOARDING */

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }

    .overlay.hidden {
      display: none;
    }

    .modal {
      background: white;
      padding: 20px;
      border-radius: 14px;
      max-width: 400px;
      width: 90%;
    }

    .modal h2 { margin-top: 0; }

    .field { margin-bottom: 12px; }

    .lang-btn {
      padding: 6px 10px;
      border-radius: 20px;
      border: 1px solid #ccc;
      background: #f7f7f7;
      cursor: pointer;
      font-size: 12px;
      margin-right: 5px;
    }

    .lang-btn.active {
      background: #4a90e2;
      color: white;
      border-color: #4a90e2;
    }

    .small-note {
      font-size: 11px;
      color: #666;
    }

    .error-text {
      color: #b00020;
      font-size: 12px;
      margin-bottom: 8px;
    }
  </style>
</head>

<body>
<div class="app">
  <header>
    <h1 id="title-text">Shopping App</h1>
    <p id="subtitle-text">Shared family shopping list</p>
  </header>

  <div class="input-block">
    <div class="row">
      <input id="item-input" type="text" placeholder="Milk bread eggs" />
      <button id="add-btn" class="btn-primary" disabled>+</button>
    </div>
    <small id="hint-text">Tap üé§ on the keyboard for voice input</small>
  </div>

  <div class="list">
    <ul id="items-list"></ul>
  </div>

  <div class="footer-buttons">
    <button id="clear-bought-btn" class="btn-clear-bought">Clear bought</button>
    <button id="clear-all-btn" class="btn-clear-all">Clear all</button>
  </div>

  <div class="family-info">
    <div id="user-info"></div>
    <div id="family-code-line" style="display:none;">
      Family code: <span id="family-code-box" class="family-code-box">----</span>
    </div>
  </div>
</div>

<!-- ONBOARDING -->
<div id="onboarding" class="overlay">
  <div class="modal">
    <h2 id="ob-title">Welcome to Shopping App!</h2>
    <p id="ob-text">Set your name, language, and family group.</p>

    <div id="ob-error" class="error-text" style="display:none;"></div>

    <div class="field">
      <label>Your name</label>
      <input id="ob-name" type="text" />
    </div>

    <div class="field">
      <label>Language</label><br>
      <button class="lang-btn" data-lang="en">English</button>
      <button class="lang-btn" data-lang="ru">–†—É—Å—Å–∫–∏–π</button>
      <button class="lang-btn" data-lang="fi">Suomi</button>
    </div>

    <div class="field">
      <label>Family</label>
      <label><input type="radio" name="family-mode" value="create" checked> Create new family</label><br>
      <label><input type="radio" name="family-mode" value="join"> Join family by code</label><br>
      <input id="ob-family-code" type="text" placeholder="ABC123" style="margin-top:6px; display:none;">
    </div>

    <button id="ob-continue" class="btn-primary" style="width:100%;">Continue</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
/* ---------------- FIREBASE CONFIG ---------------- */
const firebaseConfig = {
  apiKey: "AIZaSDyI1R7z7El1w2uhvEdRPp1jq-e23HrblY",
  authDomain: "shopping-app-907fc.firebaseapp.com",
  projectId: "shopping-app-907fc",
  storageBucket: "shopping-app-907fc.firebasestorage.app",
  messagingSenderId: "101856550372",
  appId: "1:101856550372:web:348c7fff7e07d1dd7247f1",
  databaseURL: "https://shopping-app-907fc-default-rtdb.europe-west1.firebasedatabase.app"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ---------------- STATE ---------------- */
let currentUser = null;
let currentLang = "en";
let items = {};
const USER_KEY = "shopping-app-user-id";

/* ---------------- TRANSLATIONS ---------------- */
const t = {
  en: {
    appName: "Shopping App",
    subtitle: "Shared family shopping list",
    placeholder: "Milk bread eggs",
    add: "Add",
    clearBought: "Clear bought",
    clearAll: "Clear all",
    empty: "List is empty",
    addedBy: name => `added by ${name}`,
    onboardingWelcome: "Welcome to Shopping App!",
    onboardingExplain: "Set your name, language, and family group.",
    username: "Your name",
    familyCodeNotFound: "Family code not found",
  },
  ru: {
    appName: "–®–æ–ø–∏–Ω–≥ –ê–ü–ü",
    subtitle: "–û–±—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –¥–ª—è —Å–µ–º—å–∏",
    placeholder: "–ú–æ–ª–æ–∫–æ —Ö–ª–µ–± —è–π—Ü–∞",
    add: "–î–æ–±–∞–≤–∏—Ç—å",
    clearBought: "–û—á–∏—Å—Ç–∏—Ç—å –∫—É–ø–ª–µ–Ω–Ω—ã–µ",
    clearAll: "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë",
    empty: "–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç",
    addedBy: name => `–¥–æ–±–∞–≤–∏–ª(–∞): ${name}`,
    onboardingWelcome: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –®–æ–ø–∏–Ω–≥ –ê–ü–ü!",
    onboardingExplain: "–£–∫–∞–∂–∏ —Å–≤–æ—ë –∏–º—è, —è–∑—ã–∫ –∏ —Å–µ–º—å—é.",
    username: "–¢–≤–æ—ë –∏–º—è",
    familyCodeNotFound: "–ö–æ–¥ —Å–µ–º—å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω",
  },
  fi: {
    appName: "Shopping App",
    subtitle: "Yhteinen ostoslista perheelle",
    placeholder: "Maito leip√§ munat",
    add: "Lis√§√§",
    clearBought: "Poista ostetut",
    clearAll: "Tyhjenn√§ lista",
    empty: "Lista on tyhj√§",
    addedBy: name => `lis√§si ${name}`,
    onboardingWelcome: "Tervetuloa Shopping Appiin!",
    onboardingExplain: "Aseta nimesi, kielesi ja perheesi.",
    username: "Nimesi",
    familyCodeNotFound: "Perhekoodia ei l√∂ytynyt",
  }
};

/* ---------------- UTILS ---------------- */
function randomId(prefix) {
  return prefix + Math.random().toString(36).substring(2, 10);
}

/* ---------------- ONBOARDING ---------------- */
function applyTranslations() {
  const dict = t[currentLang];
  document.getElementById("title-text").textContent = dict.appName;
  document.getElementById("subtitle-text").textContent = dict.subtitle;
  document.getElementById("item-input").placeholder = dict.placeholder;
  document.getElementById("clear-bought-btn").textContent = dict.clearBought;
  document.getElementById("clear-all-btn").textContent = dict.clearAll;
}

function showOnboarding() {
  document.getElementById("onboarding").classList.remove("hidden");
}

function completeOnboarding() {
  document.getElementById("onboarding").classList.add("hidden");
}

/* ---------------- LIST ---------------- */
function renderList() {
  const ul = document.getElementById("items-list");
  ul.innerHTML = "";

  const keys = Object.keys(items);
  if (keys.length === 0) {
    ul.innerHTML = `<li><span style="color:#999">${t[currentLang].empty}</span></li>`;
    return;
  }

  keys.sort((a, b) => items[a].createdAt - items[b].createdAt);

  for (let id of keys) {
    const it = items[id];
    const li = document.createElement("li");
    if (it.bought) li.classList.add("bought");

    const cb = document.createElement("div");
    cb.className = "checkbox" + (it.bought ? " checked" : "");
    cb.innerHTML = it.bought ? "‚úì" : "";
    cb.onclick = () => {
      db.ref("lists/" + currentUser.familyId + "/items/" + id).update({
        bought: !it.bought
      });
    };

    const name = document.createElement("span");
    name.className = "name";
    name.textContent = it.name;

    const meta = document.createElement("span");
    meta.className = "meta";
    meta.textContent = t[currentLang].addedBy(it.addedByName || "?");

    const del = document.createElement("button");
    del.className = "btn-delete";
    del.textContent = "‚úï";
    del.onclick = () => {
      db.ref("lists/" + currentUser.familyId + "/items/" + id).remove();
    };

    const left = document.createElement("div");
    left.style.flex = "1";
    left.style.display = "flex";
    left.style.flexDirection = "column";
    left.appendChild(name);
    left.appendChild(meta);

    li.appendChild(cb);
    li.appendChild(left);
    li.appendChild(del);
    ul.appendChild(li);
  }
}

/* ---------------- INIT ---------------- */
window.onload = function () {
  const input = document.getElementById("item-input");
  const addBtn = document.getElementById("add-btn");

  addBtn.onclick = () => {
    const text = input.value.trim();
    if (!text) return;
    const parts = text.split(/[,;\n ]+/).filter(Boolean);

    const ref = db.ref("lists/" + currentUser.familyId + "/items");
    const now = Date.now();

    parts.forEach((p, i) => {
      ref.push({
        name: p,
        bought: false,
        addedById: currentUser.id,
        addedByName: currentUser.name,
        createdAt: now + i
      });
    });

    input.value = "";
    addBtn.disabled = true;
  };

  input.oninput = () => {
    addBtn.disabled = input.value.trim().length === 0;
  };

  document.querySelectorAll(".lang-btn").forEach(b => {
    b.onclick = () => {
      currentLang = b.dataset.lang;
      document.querySelectorAll(".lang-btn").forEach(x =>
        x.classList.remove("active")
      );
      b.classList.add("active");
      applyTranslations();
    };
  });

  const stored = localStorage.getItem(USER_KEY);
  if (!stored) {
    showOnboarding();
  } else {
    initUser(stored);
  }

  document.querySelectorAll("input[name='family-mode']").forEach(r => {
    r.onchange = () => {
      document.getElementById("ob-family-code").style.display =
        r.value === "join" ? "block" : "none";
    };
  });

  document.getElementById("ob-continue").onclick = () => {
    const name = document.getElementById("ob-name").value.trim();
    if (!name) {
      document.getElementById("ob-error").innerText = "Enter name";
      document.getElementById("ob-error").style.display = "block";
      return;
    }

    let userId = localStorage.getItem(USER_KEY);
    if (!userId) {
      userId = randomId("u_");
      localStorage.setItem(USER_KEY, userId);
    }

    const mode = document.querySelector("input[name='family-mode']:checked").value;

    if (mode === "create") {
      const familyId = randomId("f_");
      const familyCode = randomId("C").substring(1, 7).toUpperCase();

      const userData = {
        id: userId,
        name,
        language: currentLang,
        familyId
      };

      const updates = {};
      updates["users/" + userId] = userData;
      updates["families/" + familyId] = { code: familyCode };
      updates["familyCodes/" + familyCode] = familyId;

      db.ref().update(updates).then(() => {
        currentUser = userData;
        document.getElementById("onboarding").classList.add("hidden");
        loadList();
        showFamilyCode(familyCode);
        applyTranslations();
      });

    } else {
      const code = document.getElementById("ob-family-code").value.trim().toUpperCase();
      db.ref("familyCodes/" + code).once("value").then(s => {
        if (!s.exists()) {
          document.getElementById("ob-error").innerText =
            t[currentLang].familyCodeNotFound;
          document.getElementById("ob-error").style.display = "block";
          return;
        }

        const familyId = s.val();
        const userData = {
          id: userId,
          name,
          language: currentLang,
          familyId
        };

        db.ref("users/" + userId)
          .set(userData)
          .then(() => {
            currentUser = userData;
            document.getElementById("onboarding").classList.add("hidden");
            loadList();
            showFamilyCode(code);
            applyTranslations();
          });
      });
    }
  };
};

function initUser(userId) {
  db.ref("users/" + userId).once("value").then(s => {
    if (!s.exists()) {
      showOnboarding();
      return;
    }

    currentUser = s.val();
    currentLang = currentUser.language || "en";
    applyTranslations();

    document.getElementById("onboarding").classList.add("hidden");
    showFamilyCodeAuto();
    loadList();
  });
}

function loadList() {
  db.ref("lists/" + currentUser.familyId + "/items").on("value", s => {
    items = s.val() || {};
    renderList();
  });
}

function showFamilyCode(code) {
  document.getElementById("family-code-line").style.display = "block";
  document.getElementById("family-code-box").innerText = code;
}

function showFamilyCodeAuto() {
  db.ref("families/" + currentUser.familyId + "/code").once("value").then(s => {
    if (s.exists()) {
      showFamilyCode(s.val());
    }
  });
}
</script>

</body>
</html>
