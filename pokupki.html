<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<title>Shopping App</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="icon" href="icon.png" type="image/png">
<link rel="apple-touch-icon" href="icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">

<style>
body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    margin: 0;
    padding: 0;
    background: #f4f4f4;
    color: #222;
}

.app {
    max-width: 480px;
    margin: 0 auto;
    min-height: 100vh;
    background: #ffffff;
    display: flex;
    flex-direction: column;
}

header {
    padding: 16px;
    background: #4a90e2;
    color: white;
    text-align: center;
}

header h1 {
    margin: 0;
    font-size: 20px;
}

header p {
    margin: 4px 0 0;
    font-size: 13px;
    opacity: 0.9;
}

.user-bar {
    padding: 8px 16px 6px;
    text-align: center;
    background: #f8f9ff;
    border-bottom: 1px solid #e2e4ff;
}

.user-name {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 4px;
}

.family-pill {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 3px 10px;
    border-radius: 999px;
    background: #eef3ff;
    border: 1px dashed #4a90e2;
    font-size: 11px;
    color: #334;
}

.family-pill-label {
    opacity: 0.8;
}

.family-pill-code {
    font-weight: 700;
    letter-spacing: 1px;
}

.list {
    flex: 1;
    overflow-y: auto;
    padding: 8px 0 16px;
}

ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

li {
    display: flex;
    align-items: center;
    padding: 8px 16px;
    border-bottom: 1px solid #eee;
    gap: 10px;
}

li .name {
    flex: 1;
    font-size: 16px;
}

li .meta {
    font-size: 11px;
    color: #999;
}

li.bought .name {
    text-decoration: line-through;
    color: #999;
}

.checkbox {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid #4a90e2;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    cursor: pointer;
    flex-shrink: 0;
}

.checkbox.checked {
    background: #4a90e2;
    color: white;
}

.btn-delete {
    background: transparent;
    color: #ccc;
    font-size: 18px;
    padding: 4px 6px;
    cursor: pointer;
}

.btn-delete:hover {
    color: #999;
}

/* –∫–Ω–æ–ø–∫–∞ –∫–∞–º–µ—Ä—ã —É —Ç–æ–≤–∞—Ä–∞ */
.btn-photo {
    background: transparent;
    font-size: 18px;
    padding: 4px 6px;
    cursor: pointer;
    color: #4a90e2;
    flex-shrink: 0;
}

.btn-photo:hover {
    opacity: 0.8;
}

/* –º–∏–Ω–∏-–ø—Ä–µ–≤—å—é —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ */
.item-photo-thumb {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
}

.footer-buttons {
    padding: 8px 16px 4px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 8px;
    background: #fafafa;
    flex-wrap: wrap;
}

button {
    border-radius: 8px;
    border: none;
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
    white-space: nowrap;
}

.btn-primary {
    background: #4a90e2;
    color: white;
}

.btn-primary:disabled {
    opacity: 0.5;
    cursor: default;
}

.btn-clear-bought {
    background: #f8d7da;
    color: #721c24;
}

.btn-clear-all {
    background: #e2e3e5;
    color: #383d41;
}

/* –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –±–ª–æ–∫ –≤–≤–æ–¥–∞ */
.input-block {
    padding: 6px 12px 10px;
    border-top: 1px solid #eee;
    background: #ffffff;
}

.mode-toggle {
    display: inline-flex;
    gap: 6px;
    margin-bottom: 4px;
}

.mode-btn {
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid #ccc;
    background: #f7f7f7;
    font-size: 14px;
    cursor: pointer;
}

.mode-btn.active {
    background: #4a90e2;
    color: #fff;
    border-color: #4a90e2;
}

.row {
    display: flex;
    gap: 8px;
}

input[type="text"] {
    flex: 1;
    padding: 8px 10px;
    font-size: 16px;
    border-radius: 8px;
    border: 1px solid #ccc;
    outline: none;
}

input[type="text"]:focus {
    border-color: #4a90e2;
}

.hint {
    font-size: 11px;
    color: #666;
    padding: 2px 4px 0;
}

/* –±—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ */
.quick-products {
    margin-top: 6px;
    display: none;
    gap: 6px;
    flex-wrap: nowrap;
    overflow-x: auto;
    padding-top: 4px;
}

.quick-products::-webkit-scrollbar {
    display: none;
}

.quick-btn {
    border-radius: 999px;
    border: 1px solid #ddd;
    background: #f5f5f5;
    padding: 4px 10px;
    font-size: 12px;
    cursor: pointer;
    flex-shrink: 0;
}

.overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.overlay.hidden {
    display: none;
}

.modal {
    width: 100%;
    max-width: 420px;
    background: #fff;
    border-radius: 16px;
    padding: 16px 18px 18px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

.modal h2 {
    margin: 0 0 8px;
    font-size: 18px;
}

.modal p {
    margin: 4px 0 10px;
    font-size: 13px;
    color: #555;
}

.field {
    margin-bottom: 10px;
}

.field label {
    display: block;
    font-size: 13px;
    margin-bottom: 4px;
}

.field input[type="text"] {
    width: 100%;
    box-sizing: border-box;
}

.flag-buttons {
    display: flex;
    justify-content: center;
    gap: 16px;
    padding: 12px 0;
}

.flag-btn {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: 2px solid transparent;
    font-size: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f7f7f7;
    cursor: pointer;
}

.flag-btn.active {
    border-color: #4a90e2;
    box-shadow: 0 0 0 2px rgba(74,144,226,0.2);
    background: #eef3ff;
}

.lang-buttons {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.lang-btn {
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid #ccc;
    background: #f7f7f7;
    font-size: 12px;
    cursor: pointer;
}

.lang-btn.active {
    background: #4a90e2;
    color: white;
    border-color: #4a90e2;
}

.family-options {
    display: flex;
    flex-direction: column;
    gap: 4px;
    font-size: 13px;
}

.family-options label {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
}

.small-note {
    font-size: 11px;
    color: #777;
}

.error-text {
    font-size: 12px;
    color: #b00020;
    margin-bottom: 6px;
}

.modal-footer {
    margin-top: 10px;
    display: flex;
    justify-content: flex-end;
}

.modal-footer button {
    min-width: 120px;
}

#setup-step {
    display: none;
}

@media (max-width: 480px) {
    .modal {
        margin: 0 8px;
    }
}
</style>
</head>
<body>
<div class="app">
    <header>
        <h1 id="title-text">Shopping App</h1>
        <p id="subtitle-text">Shared family shopping list</p>
    </header>

    <div class="user-bar">
        <div id="user-info" class="user-name"></div>
        <div id="family-code-line" style="display:none;">
            <div class="family-pill">
                <span id="family-code-label" class="family-pill-label"></span>
                <span id="family-code-box" class="family-pill-code">------</span>
            </div>
        </div>
    </div>

    <div class="list">
        <ul id="items-list"></ul>
    </div>

    <div class="footer-buttons">
        <button id="clear-bought-btn" class="btn-clear-bought">Clear bought</button>
        <button id="clear-all-btn" class="btn-clear-all">Clear all</button>
        <button id="share-btn" class="btn-primary">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º</button>
    </div>

    <!-- –æ–¥–∏–Ω –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –±–ª–æ–∫: —Ä–µ–∂–∏–º ‚úçÔ∏è / üé§ + –æ–¥–Ω–æ –ø–æ–ª–µ –≤–≤–æ–¥–∞ -->
    <div class="input-block">
        <div class="mode-toggle">
            <button type="button" class="mode-btn active" data-mode="manual" id="mode-manual">‚úçÔ∏è</button>
            <button type="button" class="mode-btn" data-mode="voice" id="mode-voice">üé§</button>
        </div>
        <div class="row">
            <input id="item-input" type="text" placeholder="Milk bread eggs" />
            <button id="add-btn" class="btn-primary" disabled>+</button>
        </div>
        <div class="hint" id="hint-text">
            <!-- —Ç–µ–∫—Å—Ç –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –∏–∑ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ -->
        </div>
        <!-- –±—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ -->
        <div class="quick-products" id="quick-products"></div>
    </div>
</div>

<div id="onboarding" class="overlay">
    <div class="modal">
        <div id="lang-step">
            <div class="flag-buttons">
                <button type="button" class="flag-btn" data-lang="ru">üá∑üá∫</button>
                <button type="button" class="flag-btn" data-lang="en">üá¨üáß</button>
                <button type="button" class="flag-btn" data-lang="fi">üá´üáÆ</button>
            </div>
        </div>

        <div id="setup-step">
            <h2 id="ob-title">Welcome!</h2>
            <p id="ob-text">Set your name and family.</p>

            <div id="ob-error" class="error-text" style="display:none;"></div>

            <div class="field">
                <label id="label-name" for="ob-name">Your name</label>
                <input type="text" id="ob-name" />
            </div>

            <div class="field">
                <label id="label-lang">Language</label>
                <div class="lang-buttons">
                    <button type="button" class="lang-btn" data-lang="ru">–†—É—Å—Å–∫–∏–π</button>
                    <button type="button" class="lang-btn" data-lang="en">English</button>
                    <button type="button" class="lang-btn" data-lang="fi">Suomi</button>
                </div>
            </div>

            <div class="field">
                <label id="label-family">Family</label>
                <div class="family-options">
                    <label>
                        <input type="radio" name="family-mode" value="create" checked />
                        <span id="label-create-family">Create my own family</span>
                    </label>
                    <label>
                        <input type="radio" name="family-mode" value="join" />
                        <span id="label-join-family">Join family by code</span>
                    </label>
                    <input type="text" id="ob-family-code" placeholder="ABC123" style="margin-top:4px; display:none;" />
                    <div class="small-note" id="label-family-note">
                        If you join, ask family member for a code.
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button id="ob-continue" class="btn-primary">Continue</button>
            </div>
        </div>
    </div>
</div>

<!-- —Å–∫—Ä—ã—Ç—ã–π –∏–Ω–ø—É—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞ -->
<input type="file" id="photo-input" accept="image/*" style="display:none" />

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIZaSDyI1R7z7El1w2uhvEdRPp1jq-e23HrblY",
    authDomain: "shopping-app-907fc.firebaseapp.com",
    projectId: "shopping-app-907fc",
    storageBucket: "shopping-app-907fc.firebasestorage.app",
    messagingSenderId: "101856550372",
    appId: "1:101856550372:web:348c7fff7e07d1dd7247f1",
    databaseURL: "https://shopping-app-907fc-default-rtdb.europe-west1.firebasedatabase.app"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

const USER_ID_KEY = 'shopping-app-user-id';

let currentLang = 'ru';
let currentUser = null;
let currentFamilyCode = null;
let itemsMap = {};
let autoAddTimer = null;
let currentMode = 'manual'; // 'manual' –∏–ª–∏ 'voice'
let photoTargetItemId = null;
let popularProducts = [];

const $ = id => document.getElementById(id);

// === —Å–ª–æ–≤–∞—Ä—å –ø—Ä–æ–¥—É–∫—Ç–æ–≤, —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π ===
const productDictionary = {
    // –ú–û–õ–û–ö–û
    "–º–æ–ª–æ–∫–æ": { ru: "–º–æ–ª–æ–∫–æ", en: "milk", fi: "maito" },
    "milk": { ru: "–º–æ–ª–æ–∫–æ", en: "milk", fi: "maito" },
    "maito": { ru: "–º–æ–ª–æ–∫–æ", en: "milk", fi: "maito" },

    // –•–õ–ï–ë
    "—Ö–ª–µ–±": { ru: "—Ö–ª–µ–±", en: "bread", fi: "leip√§" },
    "bread": { ru: "—Ö–ª–µ–±", en: "bread", fi: "leip√§" },
    "leip√§": { ru: "—Ö–ª–µ–±", en: "bread", fi: "leip√§" },

    // –ß–Å–†–ù–´–ô –•–õ–ï–ë
    "—á–µ—Ä–Ω—ã–π —Ö–ª–µ–±": { ru: "—á—ë—Ä–Ω—ã–π —Ö–ª–µ–±", en: "black bread", fi: "ruisleip√§" },
    "—á—ë—Ä–Ω—ã–π —Ö–ª–µ–±": { ru: "—á—ë—Ä–Ω—ã–π —Ö–ª–µ–±", en: "black bread", fi: "ruisleip√§" },
    "black bread": { ru: "—á—ë—Ä–Ω—ã–π —Ö–ª–µ–±", en: "black bread", fi: "ruisleip√§" },
    "dark bread": { ru: "—á—ë—Ä–Ω—ã–π —Ö–ª–µ–±", en: "dark bread", fi: "ruisleip√§" },
    "ruisleip√§": { ru: "—á—ë—Ä–Ω—ã–π —Ö–ª–µ–±", en: "black bread", fi: "ruisleip√§" },

    // –ë–ï–õ–´–ô –•–õ–ï–ë
    "–±–µ–ª—ã–π —Ö–ª–µ–±": { ru: "–±–µ–ª—ã–π —Ö–ª–µ–±", en: "white bread", fi: "vaalea leip√§" },
    "white bread": { ru: "–±–µ–ª—ã–π —Ö–ª–µ–±", en: "white bread", fi: "vaalea leip√§" },
    "vaalea leip√§": { ru: "–±–µ–ª—ã–π —Ö–ª–µ–±", en: "white bread", fi: "vaalea leip√§" },

    // –Ø–ô–¶–ê
    "—è–π—Ü–∞": { ru: "—è–π—Ü–∞", en: "eggs", fi: "munat" },
    "—è–π—Ü–æ": { ru: "—è–π—Ü–∞", en: "eggs", fi: "munat" },
    "egg": { ru: "—è–π—Ü–∞", en: "eggs", fi: "munat" },
    "eggs": { ru: "—è–π—Ü–∞", en: "eggs", fi: "munat" },
    "munat": { ru: "—è–π—Ü–∞", en: "eggs", fi: "munat" },

    // –ö–ê–†–¢–û–®–ö–ê
    "–∫–∞—Ä—Ç–æ—à–∫–∞": { ru: "–∫–∞—Ä—Ç–æ—à–∫–∞", en: "potatoes", fi: "perunat" },
    "–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å": { ru: "–∫–∞—Ä—Ç–æ—à–∫–∞", en: "potatoes", fi: "perunat" },
    "potato": { ru: "–∫–∞—Ä—Ç–æ—à–∫–∞", en: "potato", fi: "peruna" },
    "potatoes": { ru: "–∫–∞—Ä—Ç–æ—à–∫–∞", en: "potatoes", fi: "perunat" },
    "peruna": { ru: "–∫–∞—Ä—Ç–æ—à–∫–∞", en: "potato", fi: "peruna" },
    "perunat": { ru: "–∫–∞—Ä—Ç–æ—à–∫–∞", en: "potatoes", fi: "perunat" },

    // –û–ì–£–†–¶–´
    "–æ–≥—É—Ä–µ—Ü": { ru: "–æ–≥—É—Ä–µ—Ü", en: "cucumber", fi: "kurkku" },
    "–æ–≥—É—Ä—Ü—ã": { ru: "–æ–≥—É—Ä—Ü—ã", en: "cucumbers", fi: "kurkut" },
    "cucumber": { ru: "–æ–≥—É—Ä–µ—Ü", en: "cucumber", fi: "kurkku" },
    "cucumbers": { ru: "–æ–≥—É—Ä—Ü—ã", en: "cucumbers", fi: "kurkut" },
    "kurkku": { ru: "–æ–≥—É—Ä–µ—Ü", en: "cucumber", fi: "kurkku" },
    "kurkut": { ru: "–æ–≥—É—Ä—Ü—ã", en: "cucumbers", fi: "kurkut" },

    // –õ–£–ö
    "–ª—É–∫": { ru: "–ª—É–∫", en: "onion", fi: "sipuli" },
    "—Ä–µ–ø—á–∞—Ç—ã–π –ª—É–∫": { ru: "–ª—É–∫", en: "onion", fi: "sipuli" },
    "onion": { ru: "–ª—É–∫", en: "onion", fi: "sipuli" },
    "onions": { ru: "–ª—É–∫", en: "onions", fi: "sipulit" },
    "sipuli": { ru: "–ª—É–∫", en: "onion", fi: "sipuli" },
    "sipulit": { ru: "–ª—É–∫", en: "onions", fi: "sipulit" },

    // –ú–û–†–ö–û–í–¨
    "–º–æ—Ä–∫–æ–≤—å": { ru: "–º–æ—Ä–∫–æ–≤—å", en: "carrot", fi: "porkkana" },
    "–º–æ—Ä–∫–æ–≤–∫–∞": { ru: "–º–æ—Ä–∫–æ–≤—å", en: "carrot", fi: "porkkana" },
    "carrot": { ru: "–º–æ—Ä–∫–æ–≤—å", en: "carrot", fi: "porkkana" },
    "carrots": { ru: "–º–æ—Ä–∫–æ–≤—å", en: "carrots", fi: "porkkanat" },
    "porkkana": { ru: "–º–æ—Ä–∫–æ–≤—å", en: "carrot", fi: "porkkana" },
    "porkkanat": { ru: "–º–æ—Ä–∫–æ–≤—å", en: "carrots", fi: "porkkanat" },

    // –°–í–Å–ö–õ–ê
    "—Å–≤–µ–∫–ª–∞": { ru: "—Å–≤—ë–∫–ª–∞", en: "beetroot", fi: "punajuuri" },
    "—Å–≤—ë–∫–ª–∞": { ru: "—Å–≤—ë–∫–ª–∞", en: "beetroot", fi: "punajuuri" },
    "beetroot": { ru: "—Å–≤—ë–∫–ª–∞", en: "beetroot", fi: "punajuuri" },
    "punajuuri": { ru: "—Å–≤—ë–∫–ª–∞", en: "beetroot", fi: "punajuuri" },

    // –ö–ê–ü–£–°–¢–ê
    "–∫–∞–ø—É—Å—Ç–∞": { ru: "–∫–∞–ø—É—Å—Ç–∞", en: "cabbage", fi: "kaali" },
    "cabbage": { ru: "–∫–∞–ø—É—Å—Ç–∞", en: "cabbage", fi: "kaali" },
    "kaali": { ru: "–∫–∞–ø—É—Å—Ç–∞", en: "cabbage", fi: "kaali" },

    // –ü–û–ú–ò–î–û–†–´
    "–ø–æ–º–∏–¥–æ—Ä—ã":{ ru: "–ø–æ–º–∏–¥–æ—Ä—ã", en: "tomatoes", fi: "tomaatit" },
    "–ø–æ–º–∏–¥–æ—Ä":{ ru: "–ø–æ–º–∏–¥–æ—Ä—ã", en: "tomato", fi: "tomaatti" },
    "tomato": { ru: "–ø–æ–º–∏–¥–æ—Ä—ã", en: "tomato", fi: "tomaatti" },
    "tomatoes":{ ru: "–ø–æ–º–∏–¥–æ—Ä—ã", en: "tomatoes", fi: "tomaatit" },
    "tomaatti":{ ru: "–ø–æ–º–∏–¥–æ—Ä—ã", en: "tomato", fi: "tomaatti" },
    "tomaatit":{ ru: "–ø–æ–º–∏–¥–æ—Ä—ã", en: "tomatoes", fi: "tomaatit" },

    // –Ø–ë–õ–û–ö–ò
    "—è–±–ª–æ–∫–æ": { ru: "—è–±–ª–æ–∫–æ", en: "apple", fi: "omena" },
    "—è–±–ª–æ–∫–∏": { ru: "—è–±–ª–æ–∫–∏", en: "apples", fi: "omenat" },
    "apple": { ru: "—è–±–ª–æ–∫–æ", en: "apple", fi: "omena" },
    "apples": { ru: "—è–±–ª–æ–∫–∏", en: "apples", fi: "omenat" },
    "omena": { ru: "—è–±–ª–æ–∫–æ", en: "apple", fi: "omena" },
    "omenat": { ru: "—è–±–ª–æ–∫–∏", en: "apples", fi: "omenat" },

    // –ë–ê–ù–ê–ù–´
    "–±–∞–Ω–∞–Ω": { ru: "–±–∞–Ω–∞–Ω", en: "banana", fi: "banaani" },
    "–±–∞–Ω–∞–Ω—ã": { ru: "–±–∞–Ω–∞–Ω—ã", en: "bananas", fi: "banaanit" },
    "banana": { ru: "–±–∞–Ω–∞–Ω", en: "banana", fi: "banaani" },
    "bananas": { ru: "–±–∞–Ω–∞–Ω—ã", en: "bananas", fi: "banaanit" },
    "banaani": { ru: "–±–∞–Ω–∞–Ω", en: "banana", fi: "banaani" },
    "banaanit": { ru: "–±–∞–Ω–∞–Ω—ã", en: "bananas", fi: "banaanit" },

    // –ê–ü–ï–õ–¨–°–ò–ù–´
    "–∞–ø–µ–ª—å—Å–∏–Ω": { ru: "–∞–ø–µ–ª—å—Å–∏–Ω", en: "orange", fi: "appelsiini" },
    "–∞–ø–µ–ª—å—Å–∏–Ω—ã": { ru: "–∞–ø–µ–ª—å—Å–∏–Ω—ã", en: "oranges", fi: "appelsiinit" },
    "orange": { ru: "–∞–ø–µ–ª—å—Å–∏–Ω", en: "orange", fi: "appelsiini" },
    "oranges": { ru: "–∞–ø–µ–ª—å—Å–∏–Ω—ã", en: "oranges", fi: "appelsiinit" },
    "appelsiini": { ru: "–∞–ø–µ–ª—å—Å–∏–Ω", en: "orange", fi: "appelsiini" },
    "appelsiinit": { ru: "–∞–ø–µ–ª—å—Å–∏–Ω—ã", en: "oranges", fi: "appelsiinit" },

    // –õ–ò–ú–û–ù
    "–ª–∏–º–æ–Ω": { ru: "–ª–∏–º–æ–Ω", en: "lemon", fi: "sitruuna" },
    "–ª–∏–º–æ–Ω—ã": { ru: "–ª–∏–º–æ–Ω—ã", en: "lemons", fi: "sitruunat" },
    "lemon": { ru: "–ª–∏–º–æ–Ω", en: "lemon", fi: "sitruuna" },
    "lemons": { ru: "–ª–∏–º–æ–Ω—ã", en: "lemons", fi: "sitruunat" },
    "sitruuna": { ru: "–ª–∏–º–æ–Ω", en: "lemon", fi: "sitruuna" },
    "sitruunat": { ru: "–ª–∏–º–æ–Ω—ã", en: "lemons", fi: "sitruunat" },

    // –°–´–†
    "—Å—ã—Ä": { ru: "—Å—ã—Ä", en: "cheese", fi: "juusto" },
    "cheese": { ru: "—Å—ã—Ä", en: "cheese", fi: "juusto" },
    "juusto": { ru: "—Å—ã—Ä", en: "cheese", fi: "juusto" },

    // –ú–ê–°–õ–û –°–õ–ò–í–û–ß–ù–û–ï
    "–º–∞—Å–ª–æ": { ru: "–º–∞—Å–ª–æ", en: "butter", fi: "voi" },
    "—Å–ª–∏–≤–æ—á–Ω–æ–µ –º–∞—Å–ª–æ": { ru: "–º–∞—Å–ª–æ", en: "butter", fi: "voi" },
    "butter": { ru: "–º–∞—Å–ª–æ", en: "butter", fi: "voi" },
    "voi": { ru: "–º–∞—Å–ª–æ", en: "butter", fi: "voi" },

    // –ú–ê–°–õ–û –†–ê–°–¢–ò–¢–ï–õ–¨–ù–û–ï
    "—Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ –º–∞—Å–ª–æ": { ru: "—Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ –º–∞—Å–ª–æ", en: "vegetable oil", fi: "kasvi√∂ljy" },
    "–ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ –º–∞—Å–ª–æ": { ru: "–ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ –º–∞—Å–ª–æ", en: "sunflower oil", fi: "auringonkukka√∂ljy" },
    "sunflower oil": { ru: "–ø–æ–¥—Å–æ–ª–Ω–µ—á–Ω–æ–µ –º–∞—Å–ª–æ", en: "sunflower oil", fi: "auringonkukka√∂ljy" },
    "vegetable oil": { ru: "—Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ –º–∞—Å–ª–æ", en: "vegetable oil", fi: "kasvi√∂ljy" },
    "olive oil": { ru: "–æ–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ", en: "olive oil", fi: "oliivi√∂ljy" },
    "–æ–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ": { ru: "–æ–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ", en: "olive oil", fi: "oliivi√∂ljy" },

    // –°–ú–ï–¢–ê–ù–ê
    "—Å–º–µ—Ç–∞–Ω–∞": { ru: "—Å–º–µ—Ç–∞–Ω–∞", en: "sour cream", fi: "smetana" },
    "sour cream": { ru: "—Å–º–µ—Ç–∞–Ω–∞", en: "sour cream", fi: "smetana" },
    "smetana": { ru: "—Å–º–µ—Ç–∞–Ω–∞", en: "sour cream", fi: "smetana" },

    // –ô–û–ì–£–†–¢ / –ö–ï–§–ò–† / –¢–í–û–†–û–ì
    "–π–æ–≥—É—Ä—Ç": { ru: "–π–æ–≥—É—Ä—Ç", en: "yogurt", fi: "jogurtti" },
    "yogurt": { ru: "–π–æ–≥—É—Ä—Ç", en: "yogurt", fi: "jogurtti" },
    "jogurtti": { ru: "–π–æ–≥—É—Ä—Ç", en: "yogurt", fi: "jogurtti" },

    "–∫–µ—Ñ–∏—Ä": { ru: "–∫–µ—Ñ–∏—Ä", en: "kefir", fi: "kefir" },
    "kefir": { ru: "–∫–µ—Ñ–∏—Ä", en: "kefir", fi: "kefir" },

    "—Ç–≤–æ—Ä–æ–≥": { ru: "—Ç–≤–æ—Ä–æ–≥", en: "cottage cheese", fi: "raejuusto" },
    "cottage cheese": { ru: "—Ç–≤–æ—Ä–æ–≥", en: "cottage cheese", fi: "raejuusto" },
    "raejuusto": { ru: "—Ç–≤–æ—Ä–æ–≥", en: "cottage cheese", fi: "raejuusto" },

    // –ö–û–õ–ë–ê–°–ê / –°–û–°–ò–°–ö–ò
    "–∫–æ–ª–±–∞—Å–∞": { ru: "–∫–æ–ª–±–∞—Å–∞", en: "sausage", fi: "makkara" },
    "sausage": { ru: "–∫–æ–ª–±–∞—Å–∞", en: "sausage", fi: "makkara" },
    "makkara": { ru: "–∫–æ–ª–±–∞—Å–∞", en: "sausage", fi: "makkara" },

    "—Å–æ—Å–∏—Å–∫–∏": { ru: "—Å–æ—Å–∏—Å–∫–∏", en: "sausages", fi: "nakit" },
    "—Å–æ—Å–∏—Å–∫–∞": { ru: "—Å–æ—Å–∏—Å–∫–∏", en: "sausage", fi: "nakki" },
    "sausages": { ru: "—Å–æ—Å–∏—Å–∫–∏", en: "sausages", fi: "nakit" },
    "nakit": { ru: "—Å–æ—Å–∏—Å–∫–∏", en: "sausages", fi: "nakit" },

    // –§–ê–†–® / –ú–Ø–°–û
    "—Ñ–∞—Ä—à": { ru: "—Ñ–∞—Ä—à", en: "minced meat", fi: "jauheliha" },
    "minced meat": { ru: "—Ñ–∞—Ä—à", en: "minced meat", fi: "jauheliha" },
    "jauheliha": { ru: "—Ñ–∞—Ä—à", en: "minced meat", fi: "jauheliha" },

    "–≥–æ–≤—è–¥–∏–Ω–∞": { ru: "–≥–æ–≤—è–¥–∏–Ω–∞", en: "beef", fi: "naudanliha" },
    "beef": { ru: "–≥–æ–≤—è–¥–∏–Ω–∞", en: "beef", fi: "naudanliha" },
    "naudanliha": { ru: "–≥–æ–≤—è–¥–∏–Ω–∞", en: "beef", fi: "naudanliha" },

    "—Å–≤–∏–Ω–∏–Ω–∞": { ru: "—Å–≤–∏–Ω–∏–Ω–∞", en: "pork", fi: "sianliha" },
    "pork": { ru: "—Å–≤–∏–Ω–∏–Ω–∞", en: "pork", fi: "sianliha" },
    "sianliha": { ru: "—Å–≤–∏–Ω–∏–Ω–∞", en: "pork", fi: "sianliha" },

    // –ö–£–†–ò–¶–ê / –ö–†–´–õ–´–®–ö–ò / –§–ò–õ–ï
    "–∫—É—Ä–∏–Ω—ã–µ –∫—Ä—ã–ª—ã—à–∫–∏": { ru: "–∫—É—Ä–∏–Ω—ã–µ –∫—Ä—ã–ª—ã—à–∫–∏", en: "chicken wings", fi: "kanansiivet" },
    "chicken wings": { ru: "–∫—É—Ä–∏–Ω—ã–µ –∫—Ä—ã–ª—ã—à–∫–∏", en: "chicken wings", fi: "kanansiivet" },
    "kanansiivet": { ru: "–∫—É—Ä–∏–Ω—ã–µ –∫—Ä—ã–ª—ã—à–∫–∏", en: "chicken wings", fi: "kanansiivet" },

    "–∫—É—Ä–∏—Ü–∞": { ru: "–∫—É—Ä–∏—Ü–∞", en: "chicken", fi: "kana" },
    "chicken":{ ru: "–∫—É—Ä–∏—Ü–∞", en: "chicken", fi: "kana" },
    "kana": { ru: "–∫—É—Ä–∏—Ü–∞", en: "chicken", fi: "kana" },

    "–∫—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ": { ru: "–∫—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ", en: "chicken fillet", fi: "kanan filee" },
    "chicken fillet": { ru: "–∫—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ", en: "chicken fillet", fi: "kanan filee" },
    "kanan filee": { ru: "–∫—É—Ä–∏–Ω–æ–µ —Ñ–∏–ª–µ", en: "chicken fillet", fi: "kanan filee" },

    "—Ñ–∏–ª–µ —Ä—ã–±—ã": { ru: "—Ñ–∏–ª–µ —Ä—ã–±—ã", en: "fish fillet", fi: "kalafilee" },
    "fish fillet": { ru: "—Ñ–∏–ª–µ —Ä—ã–±—ã", en: "fish fillet", fi: "kalafilee" },
    "kalafilee": { ru: "—Ñ–∏–ª–µ —Ä—ã–±—ã", en: "fish fillet", fi: "kalafilee" },

    // –ö–†–£–ü–´ –ò –ú–ê–ö–ê–†–û–ù–´
    "—Ä–∏—Å": { ru: "—Ä–∏—Å", en: "rice", fi: "riisi" },
    "rice": { ru: "—Ä–∏—Å", en: "rice", fi: "riisi" },
    "riisi": { ru: "—Ä–∏—Å", en: "rice", fi: "riisi" },

    "–≥—Ä–µ—á–∫–∞": { ru: "–≥—Ä–µ—á–∫–∞", en: "buckwheat", fi: "tattari" },
    "buckwheat": { ru: "–≥—Ä–µ—á–∫–∞", en: "buckwheat", fi: "tattari" },
    "tattari": { ru: "–≥—Ä–µ—á–∫–∞", en: "buckwheat", fi: "tattari" },

    "–º–∞–∫–∞—Ä–æ–Ω—ã": { ru: "–º–∞–∫–∞—Ä–æ–Ω—ã", en: "pasta", fi: "pasta" },
    "–ø–∞—Å—Ç–∞": { ru: "–º–∞–∫–∞—Ä–æ–Ω—ã", en: "pasta", fi: "pasta" },
    "pasta": { ru: "–º–∞–∫–∞—Ä–æ–Ω—ã", en: "pasta", fi: "pasta" },

    "—Å–ø–∞–≥–µ—Ç—Ç–∏": { ru: "—Å–ø–∞–≥–µ—Ç—Ç–∏", en: "spaghetti", fi: "spagetti" },
    "spaghetti": { ru: "—Å–ø–∞–≥–µ—Ç—Ç–∏", en: "spaghetti", fi: "spagetti" },
    "spagetti": { ru: "—Å–ø–∞–≥–µ—Ç—Ç–∏", en: "spaghetti", fi: "spagetti" },

    // –°–ê–•–ê–† / –°–û–õ–¨ / –ú–£–ö–ê
    "—Å–∞—Ö–∞—Ä": { ru: "—Å–∞—Ö–∞—Ä", en: "sugar", fi: "sokeri" },
    "sugar": { ru: "—Å–∞—Ö–∞—Ä", en: "sugar", fi: "sokeri" },
    "sokeri": { ru: "—Å–∞—Ö–∞—Ä", en: "sugar", fi: "sokeri" },

    "—Å–æ–ª—å": { ru: "—Å–æ–ª—å", en: "salt", fi: "suola" },
    "salt": { ru: "—Å–æ–ª—å", en: "salt", fi: "suola" },
    "suola": { ru: "—Å–æ–ª—å", en: "salt", fi: "suola" },

    "–º—É–∫–∞": { ru: "–º—É–∫–∞", en: "flour", fi: "jauho" },
    "flour": { ru: "–º—É–∫–∞", en: "flour", fi: "jauho" },
    "jauho": { ru: "–º—É–∫–∞", en: "flour", fi: "jauho" },

    // –í–û–î–ê / –°–û–ö
    "–≤–æ–¥–∞": { ru: "–≤–æ–¥–∞", en: "water", fi: "vesi" },
    "water": { ru: "–≤–æ–¥–∞", en: "water", fi: "vesi" },
    "vesi": { ru: "–≤–æ–¥–∞", en: "water", fi: "vesi" },

    "–º–∏–Ω–µ—Ä–∞–ª—å–Ω–∞—è –≤–æ–¥–∞": { ru: "–º–∏–Ω–µ—Ä–∞–ª—å–Ω–∞—è –≤–æ–¥–∞", en: "mineral water", fi: "kivenn√§isvesi" },
    "mineral water": { ru: "–º–∏–Ω–µ—Ä–∞–ª—å–Ω–∞—è –≤–æ–¥–∞", en: "mineral water", fi: "kivenn√§isvesi" },
    "kivenn√§isvesi": { ru: "–º–∏–Ω–µ—Ä–∞–ª—å–Ω–∞—è –≤–æ–¥–∞", en: "mineral water", fi: "kivenn√§isvesi" },

    "—Å–æ–∫": { ru: "—Å–æ–∫", en: "juice", fi: "mehu" },
    "juice": { ru: "—Å–æ–∫", en: "juice", fi: "mehu" },
    "mehu": { ru: "—Å–æ–∫", en: "juice", fi: "mehu" }
};

const translations = {
    ru: {
        appTitle: 'Shopping App',
        headerSubtitle: '–û–±—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –¥–ª—è —Å–µ–º—å–∏.',
        placeholderManual: '–ù–∞–ø—Ä–∏–º–µ—Ä: —á—ë—Ä–Ω—ã–π —Ö–ª–µ–± –º–æ–ª–æ–∫–æ –∫–∞—Ä—Ç–æ—à–∫–∞',
        placeholderVoice: '–ü—Ä–æ–¥–∏–∫—Ç—É–π: –º–æ–ª–æ–∫–æ —Ö–ª–µ–± –∫–∞—Ä—Ç–æ—à–∫–∞',
        hintManual: '–†–µ–∂–∏–º ‚úçÔ∏è ‚Äî –≤—Å—ë, —á—Ç–æ –Ω–∞–±—Ä–∞–ª –≤—Ä—É—á–Ω—É—é, –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ –∏–ª–∏ Enter.',
        hintVoice: '–†–µ–∂–∏–º üé§ ‚Äî —É–¥–æ–±–Ω–æ –¥–∏–∫—Ç–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã, –ø–æ—Å–ª–µ –ø–∞—É–∑—ã —Ç–æ–≤–∞—Ä—ã –¥–æ–±–∞–≤—è—Ç—Å—è —Å–∞–º–∏.',
        addButton: '–î–æ–±–∞–≤–∏—Ç—å',
        clearBought: '–û—á–∏—Å—Ç–∏—Ç—å –∫—É–ø–ª–µ–Ω–Ω—ã–µ',
        clearAll: '–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë',
        listEmpty: '–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç',
        obTitle: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!',
        obText: '–£–∫–∞–∂–∏ —Å–≤–æ—ë –∏–º—è –∏ —Å–µ–º—å—é. –£ —á–ª–µ–Ω–æ–≤ –æ–¥–Ω–æ–π —Å–µ–º—å–∏ –±—É–¥–µ—Ç –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫.',
        labelName: '–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?',
        labelLang: '–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞',
        labelFamily: '–°–µ–º—å—è',
        labelCreateFamily: '–°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é —Å–µ–º—å—é',
        labelJoinFamily: '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å–µ–º—å–µ –ø–æ –∫–æ–¥—É',
        labelFamilyNote: '–ï—Å–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—à—å—Å—è, –ø–æ–ø—Ä–æ—Å–∏ —á–ª–µ–Ω–∞ —Å–µ–º—å–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–±–µ –∫–æ–¥.',
        obContinue: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å',
        errorNameRequired: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ –∏–º—è.',
        errorFamilyCodeNotFound: '–ö–æ–¥ —Å–µ–º—å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.',
        familyCodeLabel: '–ö–æ–¥ —Å–µ–º—å–∏:',
        userInfo: name => `${name}`,
        addedBy: name => `–¥–æ–±–∞–≤–∏–ª(–∞): ${name}`
    },
    en: {
        appTitle: 'Shopping App',
        headerSubtitle: 'Shared shopping list for your family.',
        placeholderManual: 'Example: black bread milk potatoes',
        placeholderVoice: 'Dictate: milk bread potatoes',
        hintManual: 'Mode ‚úçÔ∏è ‚Äî manual typing, items are added only by button or Enter.',
        hintVoice: 'Mode üé§ ‚Äî use keyboard mic, after a short pause items will be added automatically.',
        addButton: 'Add',
        clearBought: 'Clear bought',
        clearAll: 'Clear all',
        listEmpty: 'List is empty',
        obTitle: 'Welcome!',
        obText: 'Set your name and family. Members of one family share a shopping list.',
        labelName: 'Your name',
        labelLang: 'Interface language',
        labelFamily: 'Family',
        labelCreateFamily: 'Create my own family',
        labelJoinFamily: 'Join family by code',
        labelFamilyNote: 'To join, ask your family member for a code.',
        obContinue: 'Continue',
        errorNameRequired: 'Please enter your name.',
        errorFamilyCodeNotFound: 'Family code not found.',
        familyCodeLabel: 'Family code:',
        userInfo: name => `${name}`,
        addedBy: name => `added by ${name}`
    },
    fi: {
        appTitle: 'Shopping App',
        headerSubtitle: 'Yhteinen ostoslista perheelle.',
        placeholderManual: 'Esim: ruisleip√§ maito perunat',
        placeholderVoice: 'Sanele: maito leip√§ perunat',
        hintManual: 'Tila ‚úçÔ∏è ‚Äî k√§sin kirjoitus, tuotteet lis√§t√§√§n vain napilla tai Enterill√§.',
        hintVoice: 'Tila üé§ ‚Äî k√§yt√§ n√§pp√§imist√∂n mikki√§, pienen tauon j√§lkeen tuotteet lis√§t√§√§n automaattisesti.',
        addButton: 'Lis√§√§',
        clearBought: 'Poista ostetut',
        clearAll: 'Tyhjenn√§ lista',
        listEmpty: 'Lista on tyhj√§',
        obTitle: 'Tervetuloa!',
        obText: 'Anna nimesi ja perheesi. Samassa perheess√§ on yhteinen ostoslista.',
        labelName: 'Mik√§ on nimesi?',
        labelLang: 'K√§ytt√∂liittym√§n kieli',
        labelFamily: 'Perhe',
        labelCreateFamily: 'Luo oma perhe',
        labelJoinFamily: 'Liity perheeseen koodilla',
        labelFamilyNote: 'Jos liityt, pyyd√§ perhekoodia toiselta perheenj√§senelt√§.',
        obContinue: 'Jatka',
        errorNameRequired: 'Kirjoita nimesi.',
        errorFamilyCodeNotFound: 'Perhekoodia ei l√∂ytynyt.',
        familyCodeLabel: 'Perhekoodi:',
        userInfo: name => `${name}`,
        addedBy: name => `lis√§si ${name}`
    }
};

function randomId(prefix) {
    return prefix + Math.random().toString(36).substring(2, 10);
}

function generateFamilyCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
}

function updateHintAndPlaceholder() {
    const dict = translations[currentLang] || translations.en;
    $('item-input').placeholder = currentMode === 'manual' ? dict.placeholderManual : dict.placeholderVoice;
    $('hint-text').textContent = currentMode === 'manual' ? dict.hintManual : dict.hintVoice;
}

function applyTranslations() {
    const dict = translations[currentLang] || translations.en;
    $('title-text').textContent = dict.appTitle;
    $('subtitle-text').textContent = dict.headerSubtitle;
    $('add-btn').textContent = dict.addButton;
    $('clear-bought-btn').textContent = dict.clearBought;
    $('clear-all-btn').textContent = dict.clearAll;
    $('ob-title').textContent = dict.obTitle;
    $('ob-text').textContent = dict.obText;
    $('label-name').textContent = dict.labelName;
    $('label-lang').textContent = dict.labelLang;
    $('label-family').textContent = dict.labelFamily;
    $('label-create-family').textContent = dict.labelCreateFamily;
    $('label-join-family').textContent = dict.labelJoinFamily;
    $('label-family-note').textContent = dict.labelFamilyNote;
    $('ob-continue').textContent = dict.obContinue;
    $('family-code-label').textContent = dict.familyCodeLabel;

    if (currentUser) {
        $('user-info').textContent = dict.userInfo(currentUser.name);
    }

    updateHintAndPlaceholder();
}

function getDisplayNameForItem(item) {
    const base = (item.name || '').trim();
    if (!base) return '';
    const key = base.toLowerCase();
    const entry = productDictionary[key];

    if (!entry) {
        return base;
    }

    const target = entry[currentLang] || base;
    const ruText = entry.ru || base;

    if (currentLang !== 'ru') {
        if (target !== ruText) {
            return `${target} (${ruText})`;
        }
        return target;
    } else {
        return ruText;
    }
}

// –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π –∫–ª—é—á –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–ø–æ-—Ä—É—Å—Å–∫–∏, –µ—Å–ª–∏ –∑–Ω–∞–µ–º)
function getCanonicalKeyForName(rawName) {
    const base = (rawName || '').trim().toLowerCase();
    if (!base) return '';
    const entry = productDictionary[base];
    if (entry && entry.ru) {
        return entry.ru.toLowerCase();
    }
    return base;
}

function renderList() {
    const listEl = $('items-list');
    listEl.innerHTML = '';

    const dict = translations[currentLang] || translations.en;
    const keys = Object.keys(itemsMap);

    if (keys.length === 0) {
        const li = document.createElement('li');
        li.innerHTML = `<span class="name" style="color:#999;">${dict.listEmpty}</span>`;
        listEl.appendChild(li);
        return;
    }

    keys.sort((a, b) => {
        const ta = itemsMap[a].createdAt || 0;
        const tb = itemsMap[b].createdAt || 0;
        return ta - tb;
    });

    keys.forEach(id => {
        const item = itemsMap[id];
        const li = document.createElement('li');
        if (item.bought) li.classList.add('bought');

        const checkbox = document.createElement('div');
        checkbox.className = 'checkbox' + (item.bought ? ' checked' : '');
        checkbox.innerHTML = item.bought ? '‚úì' : '';
        checkbox.addEventListener('click', () => toggleItem(id, item));

        const nameSpan = document.createElement('span');
        nameSpan.className = 'name';
        nameSpan.textContent = getDisplayNameForItem(item);

        const metaSpan = document.createElement('span');
        metaSpan.className = 'meta';
        if (item.addedByName) {
            metaSpan.textContent = dict.addedBy(item.addedByName);
        }

        const delBtn = document.createElement('button');
        delBtn.className = 'btn-delete';
        delBtn.textContent = '‚úï';
        delBtn.addEventListener('click', () => deleteItem(id));

        const left = document.createElement('div');
        left.style.flex = '1';
        left.style.display = 'flex';
        left.style.flexDirection = 'column';
        left.appendChild(nameSpan);
        if (item.addedByName) left.appendChild(metaSpan);

        let thumb = null;
        if (item.photoUrl) {
            thumb = document.createElement('img');
            thumb.className = 'item-photo-thumb';
            thumb.src = item.photoUrl;
            thumb.alt = item.name || '';
        }

        const photoBtn = document.createElement('button');
        photoBtn.className = 'btn-photo';
        photoBtn.textContent = 'üì∑';
        photoBtn.title = '–î–æ–±–∞–≤–∏—Ç—å / –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ';
        photoBtn.addEventListener('click', () => {
            startPhotoSelectForItem(id);
        });

        li.appendChild(checkbox);
        if (thumb) li.appendChild(thumb);
        li.appendChild(left);
        li.appendChild(photoBtn);
        li.appendChild(delBtn);
        listEl.appendChild(li);
    });
}

// —Ä–µ–Ω–¥–µ—Ä –±—ã—Å—Ç—Ä—ã—Ö –∫–Ω–æ–ø–æ–∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
function renderPopularButtons() {
    const container = $('quick-products');
    if (!container) return;
    container.innerHTML = '';

    if (!popularProducts || popularProducts.length === 0) {
        container.style.display = 'none';
        return;
    }

    container.style.display = 'flex';

    popularProducts.forEach(stat => {
        const btn = document.createElement('button');
        btn.className = 'quick-btn';
        const fakeItem = { name: stat.name };
        btn.textContent = getDisplayNameForItem(fakeItem);
        btn.addEventListener('click', () => {
            // –¥–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω —ç—Ç–æ—Ç –ø—Ä–æ–¥—É–∫—Ç —Å—Ä–∞–∑—É
            addItemsFromText(stat.name);
        });
        container.appendChild(btn);
    });
}

// —Ä–∞–∑–¥–µ–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –Ω–∞ —Ç–æ–≤–∞—Ä—ã
function splitToItems(text) {
    if (!text) return [];
    let normalized = text;

    normalized = normalized
        .replace(/–Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞/gi, '\n')
        .replace(/—Å–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–æ–∫–∞/gi, '\n')
        .replace(/—Å–ª–µ–¥—É—é—â–∏–π –ø—É–Ω–∫—Ç/gi, '\n')
        .replace(/—Å–ª–µ–¥—É—é—â–∏–π/gi, '\n')
        .replace(/enter/gi, '\n')
        .replace(/–∑–∞–ø—è—Ç–∞—è/gi, ',')
        .replace(/comma/gi, ',')
        .replace(/\s–∏\s/gi, ','); // "–∫—É—Ä–∏–Ω—ã–µ –∫—Ä—ã–ª—ã—à–∫–∏ –∏ –º–æ–ª–æ–∫–æ –∏ —Ö–ª–µ–±"

    // —Ä–µ–∂–µ–º –ø–æ –ø—Ä–æ–±–µ–ª–∞–º, –∑–∞–ø—è—Ç—ã–º –∏ –ø–µ—Ä–µ–≤–æ–¥–∞–º —Å—Ç—Ä–æ–∫–∏
    const words = normalized
        .split(/[\s,;\n]+/)
        .map(w => w.trim())
        .filter(Boolean);

    if (words.length === 0) return [];

    const result = [];
    let i = 0;

    while (i < words.length) {
        let used = false;

        // 3 —Å–ª–æ–≤–∞
        if (i + 2 < words.length) {
            const threeKey = (words[i] + ' ' + words[i+1] + ' ' + words[i+2]).toLowerCase();
            if (productDictionary[threeKey]) {
                result.push(words[i] + ' ' + words[i+1] + ' ' + words[i+2]);
                i += 3;
                used = true;
            }
        }

        // 2 —Å–ª–æ–≤–∞
        if (!used && i + 1 < words.length) {
            const twoKey = (words[i] + ' ' + words[i+1]).toLowerCase();
            if (productDictionary[twoKey]) {
                result.push(words[i] + ' ' + words[i+1]);
                i += 2;
                used = true;
            }
        }

        if (!used) {
            result.push(words[i]);
            i += 1;
        }
    }

    return result;
}

function addItemsFromText(text) {
    if (!currentUser) return;

    const parts = splitToItems(text);
    if (parts.length === 0) return;

    const existingNames = new Set(
        Object.values(itemsMap || {})
            .filter(item => !item.bought)
            .map(item => (item.name || '').toLowerCase().trim())
    );

    const now = Date.now();
    const listRef = db.ref('lists/' + currentUser.familyId + '/items');

    parts.forEach((rawName, i) => {
        const name = rawName.trim();
        if (!name) return;

        const low = name.toLowerCase();
        if (existingNames.has(low)) return;
        existingNames.add(low);

        const ref = listRef.push();
        ref.set({
            name,
            bought: false,
            addedById: currentUser.id,
            addedByName: currentUser.name,
            createdAt: now + i
        });

        // –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const canonical = getCanonicalKeyForName(name);
        if (canonical) {
            const statRef = db.ref('stats/' + currentUser.id + '/products/' + canonical);
            statRef.transaction(current => {
                if (current === null) {
                    return {
                        name: canonical,
                        count: 1,
                        lastUsed: Date.now()
                    };
                }
                return {
                    name: current.name || canonical,
                    count: (current.count || 0) + 1,
                    lastUsed: Date.now()
                };
            });
        }
    });
}

function updateAddButtonState() {
    const input = $('item-input');
    const addBtn = $('add-btn');
    addBtn.disabled = input.value.trim().length === 0;
}

function autoAddFromInput() {
    autoAddTimer = null;
    const input = $('item-input');
    const text = input.value.trim();
    if (!text) return;
    addItemsFromText(text);
    input.value = '';
    updateAddButtonState();
}

function toggleItem(id, item) {
    if (!currentUser) return;
    const ref = db.ref('lists/' + currentUser.familyId + '/items/' + id);
    ref.update({ bought: !item.bought });
}

function deleteItem(id) {
    if (!currentUser) return;
    const ref = db.ref('lists/' + currentUser.familyId + '/items/' + id);
    ref.remove();
}

function clearBought() {
    if (!currentUser) return;
    const listRef = db.ref('lists/' + currentUser.familyId + '/items');
    Object.keys(itemsMap).forEach(id => {
        if (itemsMap[id].bought) {
            listRef.child(id).remove();
        }
    });
}

function clearAll() {
    if (!currentUser) return;
    if (!confirm('Delete all items?')) return;
    const listRef = db.ref('lists/' + currentUser.familyId + '/items');
    listRef.remove();
}

function subscribeToList() {
    if (!currentUser) return;
    const listRef = db.ref('lists/' + currentUser.familyId + '/items');
    listRef.on('value', snap => {
        itemsMap = snap.val() || {};
        renderList();
    });
}

// –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
function subscribeToPopularProducts() {
    if (!currentUser) return;
    const statsRef = db.ref('stats/' + currentUser.id + '/products');
    statsRef.on('value', snap => {
        const val = snap.val() || {};
        const list = Object.values(val);
        list.sort((a, b) => {
            const ca = a.count || 0;
            const cb = b.count || 0;
            if (cb !== ca) return cb - ca;
            const la = a.lastUsed || 0;
            const lb = b.lastUsed || 0;
            return lb - la;
        });
        popularProducts = list.slice(0, 8);
        renderPopularButtons();
    });
}

function loadOrCreateFamilyCode() {
    if (!currentUser) return;
    const famRef = db.ref('families/' + currentUser.familyId);
    famRef.once('value').then(snap => {
        const val = snap.val();
        if (val && val.code) {
            currentFamilyCode = val.code;
            showFamilyCode();
        } else {
            const code = generateFamilyCode();
            currentFamilyCode = code;
            const updates = {};
            updates['families/' + currentUser.familyId] = {
                code,
                ownerId: currentUser.id,
                createdAt: Date.now()
            };
            updates['familyCodes/' + code] = currentUser.familyId;
            db.ref().update(updates).then(showFamilyCode);
        }
    });
}

function showFamilyCode() {
    if (!currentFamilyCode) return;
    $('family-code-line').style.display = 'block';
    $('family-code-box').textContent = currentFamilyCode;
}

function initUserFromDb(userId) {
    db.ref('users/' + userId).once('value').then(snap => {
        if (!snap.exists()) {
            showOnboarding();
            return;
        }
        const data = snap.val();
        currentUser = {
            id: userId,
            name: data.name || 'User',
            language: data.language || 'ru',
            familyId: data.familyId
        };
        currentLang = currentUser.language;
        applyTranslations();
        $('user-info').textContent = (translations[currentLang] || translations.en).userInfo(currentUser.name);
        $('onboarding').classList.add('hidden');
        subscribeToList();
        subscribeToPopularProducts();
        loadOrCreateFamilyCode();
    });
}

function showOnboarding() {
    $('onboarding').classList.remove('hidden');
    $('lang-step').style.display = 'block';
    $('setup-step').style.display = 'none';
    $('ob-error').style.display = 'none';
}

function setLang(lang) {
    currentLang = lang;
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
    });
    applyTranslations();
}

// –≤—ã–±–æ—Ä —Ñ–æ—Ç–æ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
function startPhotoSelectForItem(itemId) {
    if (!currentUser) return;
    const fileInput = $('photo-input');
    if (!fileInput) return;
    photoTargetItemId = itemId;
    fileInput.click();
}

// –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
function initPhotoUpload() {
    const fileInput = $('photo-input');
    if (!fileInput) return;

    fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (!file || !currentUser || !photoTargetItemId) {
            fileInput.value = '';
            photoTargetItemId = null;
            return;
        }

        const path = 'itemPhotos/' + currentUser.familyId + '/' + photoTargetItemId + '/' + Date.now() + '_' + file.name;
        const imgRef = storage.ref().child(path);

        imgRef.put(file)
            .then(snapshot => snapshot.ref.getDownloadURL())
            .then(url => {
                return db.ref('lists/' + currentUser.familyId + '/items/' + photoTargetItemId)
                    .update({ photoUrl: url });
            })
            .catch(err => {
                console.error('Photo upload error', err);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ');
            })
            .finally(() => {
                fileInput.value = '';
                photoTargetItemId = null;
            });
    });
}

window.addEventListener('DOMContentLoaded', () => {
    const input = $('item-input');
    const addBtn = $('add-btn');

    initPhotoUpload();

    // –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ ‚úçÔ∏è / üé§
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            currentMode = btn.dataset.mode;
            document.querySelectorAll('.mode-btn').forEach(b => {
                b.classList.toggle('active', b === btn);
            });
            if (autoAddTimer) {
                clearTimeout(autoAddTimer);
                autoAddTimer = null;
            }
            updateHintAndPlaceholder();
        });
    });

    // –≤–≤–æ–¥ –≤ –ø–æ–ª–µ
    input.addEventListener('input', () => {
        updateAddButtonState();
        if (autoAddTimer) clearTimeout(autoAddTimer);

        if (currentMode === 'voice' && input.value.trim().length > 0) {
            autoAddTimer = setTimeout(autoAddFromInput, 5000); // 5 —Å–µ–∫—É–Ω–¥ –ø–∞—É–∑–∞
        }
    });

    input.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            autoAddFromInput(); // –≤ –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–∞—Ö Enter –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç
        }
    });

    addBtn.addEventListener('click', () => {
        autoAddFromInput();
    });

    $('clear-bought-btn').addEventListener('click', clearBought);
    $('clear-all-btn').addEventListener('click', clearAll);

    // –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º"
    const shareBtn = document.getElementById('share-btn');
    if (shareBtn) {
        if (navigator.share) {
            // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–æ–±–∏–ª—å–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã
            shareBtn.addEventListener('click', () => {
                navigator.share({
                    title: 'Shopping App',
                    text: '–û–±—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –¥–ª—è —Å–µ–º—å–∏',
                    url: window.location.href
                }).catch(() => {
                    // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –∑–∞–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
                });
            });
        } else if (navigator.clipboard && navigator.clipboard.writeText) {
            // –ï—Å–ª–∏ Web Share –Ω–µ—Ç, –Ω–æ –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É –≤ –±—É—Ñ–µ—Ä
            shareBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(window.location.href)
                    .then(() => alert('–°—Å—ã–ª–∫–∞ –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'))
                    .catch(() => alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É'));
            });
        } else {
            // –°–æ–≤—Å–µ–º —Å—Ç–∞—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É
            shareBtn.addEventListener('click', () => {
                prompt('–°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É –Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:', window.location.href);
            });
        }
    }

    document.querySelectorAll('.flag-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const lang = btn.dataset.lang;
            currentLang = lang;
            setLang(lang);
            $('lang-step').style.display = 'none';
            $('setup-step').style.display = 'block';
        });
    });

    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            setLang(btn.dataset.lang);
        });
    });

    const codeInput = $('ob-family-code');
    document.querySelectorAll('input[name="family-mode"]').forEach(radio => {
        radio.addEventListener('change', () => {
            if (radio.value === 'join' && radio.checked) {
                codeInput.style.display = 'block';
            } else if (radio.value === 'create' && radio.checked) {
                codeInput.style.display = 'none';
            }
        });
    });

    $('ob-continue').addEventListener('click', () => {
        const dict = translations[currentLang] || translations.en;
        const name = $('ob-name').value.trim();
        if (!name) {
            $('ob-error').textContent = dict.errorNameRequired;
            $('ob-error').style.display = 'block';
            return;
        }
        const mode = document.querySelector('input[name="family-mode"]:checked').value;
        const isJoin = mode === 'join';
        let code = $('ob-family-code').value.trim().toUpperCase();

        let userId = localStorage.getItem(USER_ID_KEY);
        if (!userId) {
            userId = randomId('u_');
            localStorage.setItem(USER_ID_KEY, userId);
        }

        if (isJoin && !code) {
            $('ob-error').textContent = dict.errorFamilyCodeNotFound;
            $('ob-error').style.display = 'block';
            return;
        }

        if (isJoin) {
            db.ref('familyCodes/' + code).once('value').then(snap => {
                if (!snap.exists()) {
                    $('ob-error').textContent = dict.errorFamilyCodeNotFound;
                    $('ob-error').style.display = 'block';
                    return;
                }
                const familyId = snap.val();
                const userData = {
                    name,
                    language: currentLang,
                    familyId,
                    createdAt: Date.now()
                };
                db.ref('users/' + userId).set(userData).then(() => {
                    currentUser = { id: userId, ...userData };
                    applyTranslations();
                    $('user-info').textContent = (translations[currentLang] || translations.en).userInfo(currentUser.name);
                    $('onboarding').classList.add('hidden');
                    subscribeToList();
                    subscribeToPopularProducts();
                    db.ref('families/' + familyId + '/code').once('value').then(c => {
                        currentFamilyCode = c.val() || code;
                        showFamilyCode();
                    });
                });
            });
        } else {
            const familyId = randomId('f_');
            const familyCode = generateFamilyCode();
            const userData = {
                name,
                language: currentLang,
                familyId,
                createdAt: Date.now()
            };

            const updates = {};
            updates['users/' + userId] = userData;
            updates['families/' + familyId] = {
                code: familyCode,
                ownerId: userId,
                createdAt: Date.now()
            };
            updates['familyCodes/' + familyCode] = familyId;

            db.ref().update(updates).then(() => {
                currentUser = { id: userId, ...userData };
                currentFamilyCode = familyCode;
                applyTranslations();
                $('user-info').textContent = (translations[currentLang] || translations.en).userInfo(currentUser.name);
                $('onboarding').classList.add('hidden');
                subscribeToList();
                subscribeToPopularProducts();
                showFamilyCode();
            });
        }
    });

    const storedUserId = localStorage.getItem(USER_ID_KEY);
    if (storedUserId) {
        initUserFromDb(storedUserId);
    } else {
        showOnboarding();
    }
});
</script>
</body>
</html>
