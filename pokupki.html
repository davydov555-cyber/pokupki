<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Shopping App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="icon" href="icon.png" type="image/png">
  <link rel="apple-touch-icon" href="icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      color: #222;
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      min-height: 100vh;
      background: #ffffff;
      display: flex;
      flex-direction: column;
    }

    header {
      padding: 16px;
      background: #4a90e2;
      color: white;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
    }

    header p {
      margin: 4px 0 0;
      font-size: 13px;
      opacity: 0.9;
    }

    /* –ë–ª–æ–∫ —Å –∏–º–µ–Ω–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫–æ–¥–æ–º —Å–µ–º—å–∏ —Å—Ä–∞–∑—É –ø–æ–¥ —à–∞–ø–∫–æ–π */
    .user-bar {
      padding: 8px 16px 6px;
      text-align: center;
      background: #f8f9ff;
      border-bottom: 1px solid #e2e4ff;
    }

    .user-name {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .family-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      background: #eef3ff;
      border: 1px dashed #4a90e2;
      font-size: 11px;
      color: #334;
    }

    .family-pill-label {
      opacity: 0.8;
    }

    .family-pill-code {
      font-weight: 700;
      letter-spacing: 1px;
    }

    .list {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0 16px;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      border-bottom: 1px solid #eee;
      gap: 10px;
    }

    li .name {
      flex: 1;
      font-size: 16px;
    }

    li .meta {
      font-size: 11px;
      color: #999;
    }

    li.bought .name {
      text-decoration: line-through;
      color: #999;
    }

    .checkbox {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid #4a90e2;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .checkbox.checked {
      background: #4a90e2;
      color: white;
    }

    .btn-delete {
      background: transparent;
      color: #ccc;
      font-size: 18px;
      padding: 4px 6px;
      cursor: pointer;
    }

    .btn-delete:hover {
      color: #999;
    }

    .footer-buttons {
      padding: 8px 16px 4px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 8px;
      background: #fafafa;
      flex-wrap: wrap;
    }

    button {
      border-radius: 8px;
      border: none;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      white-space: nowrap;
    }

    .btn-primary {
      background: #4a90e2;
      color: white;
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .btn-clear-bought {
      background: #f8d7da;
      color: #721c24;
    }

    .btn-clear-all {
      background: #e2e3e5;
      color: #383d41;
    }

    .input-block {
      padding: 8px 16px 10px;
      border-top: 1px solid #eee;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: #ffffff;
    }

    .row {
      display: flex;
      gap: 8px;
    }

    input[type="text"] {
      flex: 1;
      padding: 8px 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
    }

    input[type="text"]:focus {
      border-color: #4a90e2;
    }

    .hint {
      font-size: 12px;
      color: #666;
      padding: 0 4px;
    }

    /* ONBOARDING */

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .overlay.hidden {
      display: none;
    }

    .modal {
      width: 100%;
      max-width: 420px;
      background: #fff;
      border-radius: 16px;
      padding: 16px 18px 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    }

    .modal h2 {
      margin: 0 0 8px;
      font-size: 18px;
    }

    .modal p {
      margin: 4px 0 10px;
      font-size: 13px;
      color: #555;
    }

    .field {
      margin-bottom: 10px;
    }

    .field label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }

    .field input[type="text"] {
      width: 100%;
      box-sizing: border-box;
    }

    .flag-buttons {
      display: flex;
      justify-content: center;
      gap: 16px;
      padding: 12px 0;
    }

    .flag-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 2px solid transparent;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f7f7f7;
      cursor: pointer;
    }

    .flag-btn.active {
      border-color: #4a90e2;
      box-shadow: 0 0 0 2px rgba(74,144,226,0.2);
      background: #eef3ff;
    }

    .lang-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .lang-btn {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #f7f7f7;
      font-size: 12px;
      cursor: pointer;
    }

    .lang-btn.active {
      background: #4a90e2;
      color: white;
      border-color: #4a90e2;
    }

    .family-options {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    .family-options label {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .small-note {
      font-size: 11px;
      color: #777;
    }

    .error-text {
      font-size: 12px;
      color: #b00020;
      margin-bottom: 6px;
    }

    .modal-footer {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
    }

    .modal-footer button {
      min-width: 120px;
    }

    #setup-step {
      display: none;
    }

    @media (max-width: 480px) {
      .modal {
        margin: 0 8px;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1 id="title-text">Shopping App</h1>
    <p id="subtitle-text">Shared family shopping list</p>
  </header>

  <!-- –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∫–æ–¥ —Å–µ–º—å–∏ –ø–æ–¥ –∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –ø–æ —Ü–µ–Ω—Ç—Ä—É -->
  <div class="user-bar">
    <div id="user-info" class="user-name"></div>
    <div id="family-code-line" style="display:none;">
      <div class="family-pill">
        <span id="family-code-label" class="family-pill-label"></span>
        <span id="family-code-box" class="family-pill-code">------</span>
      </div>
    </div>
  </div>

  <div class="list">
    <ul id="items-list"></ul>
  </div>

  <div class="footer-buttons">
    <button id="clear-bought-btn" class="btn-clear-bought">Clear bought</button>
    <button id="clear-all-btn" class="btn-clear-all">Clear all</button>
  </div>

  <div class="input-block">
    <div class="row">
      <input id="item-input" type="text" placeholder="Milk bread eggs" />
      <button id="add-btn" class="btn-primary" disabled>+</button>
    </div>
    <div class="hint" id="hint-text">
      Tap üé§ on keyboard for voice input.
    </div>
  </div>
</div>

<!-- ONBOARDING MODAL -->
<div id="onboarding" class="overlay">
  <div class="modal">
    <!-- STEP 1: only flags -->
    <div id="lang-step">
      <div class="flag-buttons">
        <button type="button" class="flag-btn" data-lang="ru">üá∑üá∫</button>
        <button type="button" class="flag-btn" data-lang="en">üá¨üáß</button>
        <button type="button" class="flag-btn" data-lang="fi">üá´üáÆ</button>
      </div>
    </div>

    <!-- STEP 2: name + family -->
    <div id="setup-step">
      <h2 id="ob-title">Welcome!</h2>
      <p id="ob-text">Set your name and family.</p>

      <div id="ob-error" class="error-text" style="display:none;"></div>

      <div class="field">
        <label id="label-name" for="ob-name">Your name</label>
        <input type="text" id="ob-name" />
      </div>

      <div class="field">
        <label id="label-lang">Language</label>
        <div class="lang-buttons">
          <button type="button" class="lang-btn" data-lang="ru">–†—É—Å—Å–∫–∏–π</button>
          <button type="button" class="lang-btn" data-lang="en">English</button>
          <button type="button" class="lang-btn" data-lang="fi">Suomi</button>
        </div>
      </div>

      <div class="field">
        <label id="label-family">Family</label>
        <div class="family-options">
          <label>
            <input type="radio" name="family-mode" value="create" checked />
            <span id="label-create-family">Create my own family</span>
          </label>
          <label>
            <input type="radio" name="family-mode" value="join" />
            <span id="label-join-family">Join family by code</span>
          </label>
          <input type="text" id="ob-family-code" placeholder="ABC123" style="margin-top:4px; display:none;" />
          <div class="small-note" id="label-family-note">
            If you join, ask family member for a code.
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button id="ob-continue" class="btn-primary">Continue</button>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIZaSDyI1R7z7El1w2uhvEdRPp1jq-e23HrblY",
    authDomain: "shopping-app-907fc.firebaseapp.com",
    projectId: "shopping-app-907fc",
    storageBucket: "shopping-app-907fc.firebasestorage.app",
    messagingSenderId: "101856550372",
    appId: "1:101856550372:web:348c7fff7e07d1dd7247f1",
    databaseURL: "https://shopping-app-907fc-default-rtdb.europe-west1.firebasedatabase.app"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const USER_ID_KEY = 'shopping-app-user-id';

  let currentLang = 'ru';
  let currentUser = null;
  let currentFamilyCode = null;
  let itemsMap = {};
  let autoAddTimer = null;

  const $ = id => document.getElementById(id);

  // –°–ª–æ–≤–∞—Ä–∏–∫ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
  const productDictionary = {
    "–º–æ–ª–æ–∫–æ": { ru: "–º–æ–ª–æ–∫–æ", en: "milk", fi: "maito" },
    "milk":   { ru: "–º–æ–ª–æ–∫–æ", en: "milk", fi: "maito" },
    "maito":  { ru: "–º–æ–ª–æ–∫–æ", en: "milk", fi: "maito" },

    "—Ö–ª–µ–±":   { ru: "—Ö–ª–µ–±", en: "bread", fi: "leip√§" },
    "bread":  { ru: "—Ö–ª–µ–±", en: "bread", fi: "leip√§" },
    "leip√§":  { ru: "—Ö–ª–µ–±", en: "bread", fi: "leip√§" },

    "—è–π—Ü–∞":   { ru: "—è–π—Ü–∞", en: "eggs", fi: "munat" },
    "egg":    { ru: "—è–π—Ü–∞", en: "eggs", fi: "munat" },
    "eggs":   { ru: "—è–π—Ü–∞", en: "eggs", fi: "munat" },
    "munat":  { ru: "—è–π—Ü–∞", en: "eggs", fi: "munat" },

    "–∫–∞—Ä—Ç–æ—à–∫–∞":  { ru: "–∫–∞—Ä—Ç–æ—à–∫–∞", en: "potatoes", fi: "perunat" },
    "–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å": { ru: "–∫–∞—Ä—Ç–æ—Ñ–µ–ª—å", en: "potatoes", fi: "perunat" },
    "potato":    { ru: "–∫–∞—Ä—Ç–æ—à–∫–∞", en: "potato", fi: "peruna" },
    "potatoes":  { ru: "–∫–∞—Ä—Ç–æ—à–∫–∞", en: "potatoes", fi: "perunat" },
    "peruna":    { ru: "–∫–∞—Ä—Ç–æ—à–∫–∞", en: "potato", fi: "peruna" },
    "perunat":   { ru: "–∫–∞—Ä—Ç–æ—à–∫–∞", en: "potatoes", fi: "perunat" },

    "–∫—É—Ä–∏–Ω—ã–µ –∫—Ä—ã–ª—ã—à–∫–∏": { ru: "–∫—É—Ä–∏–Ω—ã–µ –∫—Ä—ã–ª—ã—à–∫–∏", en: "chicken wings", fi: "kanansiivet" },
    "chicken wings":    { ru: "–∫—É—Ä–∏–Ω—ã–µ –∫—Ä—ã–ª—ã—à–∫–∏", en: "chicken wings", fi: "kanansiivet" },
    "kanansiivet":      { ru: "–∫—É—Ä–∏–Ω—ã–µ –∫—Ä—ã–ª—ã—à–∫–∏", en: "chicken wings", fi: "kanansiivet" },

    "–∫—É—Ä–∏—Ü–∞": { ru: "–∫—É—Ä–∏—Ü–∞", en: "chicken", fi: "kana" },
    "chicken":{ ru: "–∫—É—Ä–∏—Ü–∞", en: "chicken", fi: "kana" },
    "kana":   { ru: "–∫—É—Ä–∏—Ü–∞", en: "chicken", fi: "kana" },

    "—Å—ã—Ä":    { ru: "—Å—ã—Ä", en: "cheese", fi: "juusto" },
    "cheese": { ru: "—Å—ã—Ä", en: "cheese", fi: "juusto" },
    "juusto": { ru: "—Å—ã—Ä", en: "cheese", fi: "juusto" },

    "–º–∞—Å–ª–æ":  { ru: "–º–∞—Å–ª–æ", en: "butter", fi: "voi" },
    "butter": { ru: "–º–∞—Å–ª–æ", en: "butter", fi: "voi" },
    "voi":    { ru: "–º–∞—Å–ª–æ", en: "butter", fi: "voi" },

    "–ø–æ–º–∏–¥–æ—Ä—ã":{ ru: "–ø–æ–º–∏–¥–æ—Ä—ã", en: "tomatoes", fi: "tomaatit" },
    "tomato":  { ru: "–ø–æ–º–∏–¥–æ—Ä—ã", en: "tomato", fi: "tomaatti" },
    "tomatoes":{ ru: "–ø–æ–º–∏–¥–æ—Ä—ã", en: "tomatoes", fi: "tomaatit" },
    "tomaatti":{ ru: "–ø–æ–º–∏–¥–æ—Ä—ã", en: "tomato", fi: "tomaatti" },
    "tomaatit":{ ru: "–ø–æ–º–∏–¥–æ—Ä—ã", en: "tomatoes", fi: "tomaatit" }
  };

  const translations = {
    ru: {
      appTitle: 'Shopping App',
      headerSubtitle: '–û–±—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –¥–ª—è —Å–µ–º—å–∏.',
      placeholder: '–ù–∞–ø—Ä–∏–º–µ—Ä: –º–æ–ª–æ–∫–æ —Ö–ª–µ–± –∫–∞—Ä—Ç–æ—à–∫–∞',
      hint: '–î–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ –Ω–∞–∂–º–∏—Ç–µ üé§ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞.',
      addButton: '–î–æ–±–∞–≤–∏—Ç—å',
      clearBought: '–û—á–∏—Å—Ç–∏—Ç—å –∫—É–ø–ª–µ–Ω–Ω—ã–µ',
      clearAll: '–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë',
      listEmpty: '–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç',
      obTitle: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!',
      obText: '–£–∫–∞–∂–∏ —Å–≤–æ—ë –∏–º—è –∏ —Å–µ–º—å—é. –£ —á–ª–µ–Ω–æ–≤ –æ–¥–Ω–æ–π —Å–µ–º—å–∏ –±—É–¥–µ—Ç –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫.',
      labelName: '–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç?',
      labelLang: '–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞',
      labelFamily: '–°–µ–º—å—è',
      labelCreateFamily: '–°–æ–∑–¥–∞—Ç—å —Å–≤–æ—é —Å–µ–º—å—é',
      labelJoinFamily: '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å–µ–º—å–µ –ø–æ –∫–æ–¥—É',
      labelFamilyNote: '–ï—Å–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ—à—å—Å—è, –ø–æ–ø—Ä–æ—Å–∏ —á–ª–µ–Ω–∞ —Å–µ–º—å–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–±–µ –∫–æ–¥.',
      obContinue: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å',
      errorNameRequired: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ –∏–º—è.',
      errorFamilyCodeNotFound: '–ö–æ–¥ —Å–µ–º—å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.',
      familyCodeLabel: '–ö–æ–¥ —Å–µ–º—å–∏:',
      userInfo: name => `${name}`,
      addedBy: name => `–¥–æ–±–∞–≤–∏–ª(–∞): ${name}`
    },
    en: {
      appTitle: 'Shopping App',
      headerSubtitle: 'Shared shopping list for your family.',
      placeholder: 'Example: milk bread potatoes',
      hint: 'For voice input tap üé§ on your keyboard.',
      addButton: 'Add',
      clearBought: 'Clear bought',
      clearAll: 'Clear all',
      listEmpty: 'List is empty',
      obTitle: 'Welcome!',
      obText: 'Set your name and family. Members of one family share a shopping list.',
      labelName: 'Your name',
      labelLang: 'Interface language',
      labelFamily: 'Family',
      labelCreateFamily: 'Create my own family',
      labelJoinFamily: 'Join family by code',
      labelFamilyNote: 'To join, ask your family member for a code.',
      obContinue: 'Continue',
      errorNameRequired: 'Please enter your name.',
      errorFamilyCodeNotFound: 'Family code not found.',
      familyCodeLabel: 'Family code:',
      userInfo: name => `${name}`,
      addedBy: name => `added by ${name}`
    },
    fi: {
      appTitle: 'Shopping App',
      headerSubtitle: 'Yhteinen ostoslista perheelle.',
      placeholder: 'Esim: maito leip√§ perunat',
      hint: 'Puhetta varten paina üé§ -n√§pp√§int√§ n√§pp√§imist√∂ss√§.',
      addButton: 'Lis√§√§',
      clearBought: 'Poista ostetut',
      clearAll: 'Tyhjenn√§ lista',
      listEmpty: 'Lista on tyhj√§',
      obTitle: 'Tervetuloa!',
      obText: 'Anna nimesi ja perheesi. Samassa perheess√§ on yhteinen ostoslista.',
      labelName: 'Mik√§ on nimesi?',
      labelLang: 'K√§ytt√∂liittym√§n kieli',
      labelFamily: 'Perhe',
      labelCreateFamily: 'Luo oma perhe',
      labelJoinFamily: 'Liity perheeseen koodilla',
      labelFamilyNote: 'Jos liityt, pyyd√§ perhekoodia toiselta perheenj√§senelt√§.',
      obContinue: 'Jatka',
      errorNameRequired: 'Kirjoita nimesi.',
      errorFamilyCodeNotFound: 'Perhekoodia ei l√∂ytynyt.',
      familyCodeLabel: 'Perhekoodi:',
      userInfo: name => `${name}`,
      addedBy: name => `lis√§si ${name}`
    }
  };

  function randomId(prefix) {
    return prefix + Math.random().toString(36).substring(2, 10);
  }

  function generateFamilyCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let code = '';
    for (let i = 0; i < 6; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }

  function applyTranslations() {
    const dict = translations[currentLang] || translations.en;
    $('title-text').textContent = dict.appTitle;
    $('subtitle-text').textContent = dict.headerSubtitle;
    $('item-input').placeholder = dict.placeholder;
    $('hint-text').textContent = dict.hint;
    $('add-btn').textContent = dict.addButton;
    $('clear-bought-btn').textContent = dict.clearBought;
    $('clear-all-btn').textContent = dict.clearAll;
    $('ob-title').textContent = dict.obTitle;
    $('ob-text').textContent = dict.obText;
    $('label-name').textContent = dict.labelName;
    $('label-lang').textContent = dict.labelLang;
    $('label-family').textContent = dict.labelFamily;
    $('label-create-family').textContent = dict.labelCreateFamily;
    $('label-join-family').textContent = dict.labelJoinFamily;
    $('label-family-note').textContent = dict.labelFamilyNote;
    $('ob-continue').textContent = dict.obContinue;
    $('family-code-label').textContent = dict.familyCodeLabel;

    if (currentUser) {
      $('user-info').textContent = dict.userInfo(currentUser.name);
    }
  }

  function getDisplayNameForItem(item) {
    const base = (item.name || '').trim();
    if (!base) return '';
    const key = base.toLowerCase();
    const entry = productDictionary[key];

    if (!entry) {
      return base;
    }

    const target = entry[currentLang] || base;
    const ruText = entry.ru || base;

    if (currentLang !== 'ru') {
      if (target !== ruText) {
        return `${target} (${ruText})`;
      }
      return target;
    } else {
      return ruText;
    }
  }

  function renderList() {
    const listEl = $('items-list');
    listEl.innerHTML = '';

    const dict = translations[currentLang] || translations.en;
    const keys = Object.keys(itemsMap);

    if (keys.length === 0) {
      const li = document.createElement('li');
      li.innerHTML = `<span class="name" style="color:#999;">${dict.listEmpty}</span>`;
      listEl.appendChild(li);
      return;
    }

    keys.sort((a, b) => {
      const ta = itemsMap[a].createdAt || 0;
      const tb = itemsMap[b].createdAt || 0;
      return ta - tb;
    });

    keys.forEach(id => {
      const item = itemsMap[id];
      const li = document.createElement('li');
      if (item.bought) li.classList.add('bought');

      const checkbox = document.createElement('div');
      checkbox.className = 'checkbox' + (item.bought ? ' checked' : '');
      checkbox.innerHTML = item.bought ? '‚úì' : '';
      checkbox.addEventListener('click', () => toggleItem(id, item));

      const nameSpan = document.createElement('span');
      nameSpan.className = 'name';
      nameSpan.textContent = getDisplayNameForItem(item);

      const metaSpan = document.createElement('span');
      metaSpan.className = 'meta';
      if (item.addedByName) {
        metaSpan.textContent = dict.addedBy(item.addedByName);
      }

      const delBtn = document.createElement('button');
      delBtn.className = 'btn-delete';
      delBtn.textContent = '‚úï';
      delBtn.addEventListener('click', () => deleteItem(id));

      const left = document.createElement('div');
      left.style.flex = '1';
      left.style.display = 'flex';
      left.style.flexDirection = 'column';
      left.appendChild(nameSpan);
      if (item.addedByName) left.appendChild(metaSpan);

      li.appendChild(checkbox);
      li.appendChild(left);
      li.appendChild(delBtn);
      listEl.appendChild(li);
    });
  }

  function splitToItems(text) {
    if (!text) return [];
    let normalized = text;

    normalized = normalized
      .replace(/–Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞/gi, '\n')
      .replace(/—Å–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–æ–∫–∞/gi, '\n')
      .replace(/—Å–ª–µ–¥—É—é—â–∏–π –ø—É–Ω–∫—Ç/gi, '\n')
      .replace(/—Å–ª–µ–¥—É—é—â–∏–π/gi, '\n')
      .replace(/enter/gi, '\n')
      .replace(/–∑–∞–ø—è—Ç–∞—è/gi, ',')
      .replace(/comma/gi, ',');

    return normalized
      .split(/[,;\n]/)
      .map(p => p.trim())
      .filter(p => p.length > 0);
  }

  function addItemsFromText(text) {
    if (!currentUser) return;

    const parts = splitToItems(text);
    if (parts.length === 0) return;

    const existingNames = new Set(
      Object.values(itemsMap || {})
        .filter(item => !item.bought)
        .map(item => (item.name || '').toLowerCase().trim())
    );

    const now = Date.now();
    const listRef = db.ref('lists/' + currentUser.familyId + '/items');

    parts.forEach((rawName, i) => {
      const name = rawName.trim();
      if (!name) return;

      const low = name.toLowerCase();
      if (existingNames.has(low)) return;
      existingNames.add(low);

      const ref = listRef.push();
      ref.set({
        name,
        bought: false,
        addedById: currentUser.id,
        addedByName: currentUser.name,
        createdAt: now + i
      });
    });
  }

  function updateAddButtonState() {
    const input = $('item-input');
    const addBtn = $('add-btn');
    addBtn.disabled = input.value.trim().length === 0;
  }

  function autoAddFromInput() {
    autoAddTimer = null;
    const input = $('item-input');
    const text = input.value.trim();
    if (!text) return;
    addItemsFromText(text);
    input.value = '';
    updateAddButtonState();
  }

  function toggleItem(id, item) {
    if (!currentUser) return;
    const ref = db.ref('lists/' + currentUser.familyId + '/items/' + id);
    ref.update({ bought: !item.bought });
  }

  function deleteItem(id) {
    if (!currentUser) return;
    const ref = db.ref('lists/' + currentUser.familyId + '/items/' + id);
    ref.remove();
  }

  function clearBought() {
    if (!currentUser) return;
    const listRef = db.ref('lists/' + currentUser.familyId + '/items');
    Object.keys(itemsMap).forEach(id => {
      if (itemsMap[id].bought) {
        listRef.child(id).remove();
      }
    });
  }

  function clearAll() {
    if (!currentUser) return;
    if (!confirm('Delete all items?')) return;
    const listRef = db.ref('lists/' + currentUser.familyId + '/items');
    listRef.remove();
  }

  function subscribeToList() {
    if (!currentUser) return;
    const listRef = db.ref('lists/' + currentUser.familyId + '/items');
    listRef.on('value', snap => {
      itemsMap = snap.val() || {};
      renderList();
    });
  }

  function loadOrCreateFamilyCode() {
    if (!currentUser) return;
    const famRef = db.ref('families/' + currentUser.familyId);
    famRef.once('value').then(snap => {
      const val = snap.val();
      if (val && val.code) {
        currentFamilyCode = val.code;
        showFamilyCode();
      } else {
        const code = generateFamilyCode();
        currentFamilyCode = code;
        const updates = {};
        updates['families/' + currentUser.familyId] = {
          code,
          ownerId: currentUser.id,
          createdAt: Date.now()
        };
        updates['familyCodes/' + code] = currentUser.familyId;
        db.ref().update(updates).then(showFamilyCode);
      }
    });
  }

  function showFamilyCode() {
    if (!currentFamilyCode) return;
    $('family-code-line').style.display = 'block';
    $('family-code-box').textContent = currentFamilyCode;
  }

  function initUserFromDb(userId) {
    db.ref('users/' + userId).once('value').then(snap => {
      if (!snap.exists()) {
        showOnboarding();
        return;
      }
      const data = snap.val();
      currentUser = {
        id: userId,
        name: data.name || 'User',
        language: data.language || 'ru',
        familyId: data.familyId
      };
      currentLang = currentUser.language;
      applyTranslations();
      $('user-info').textContent = (translations[currentLang] || translations.en).userInfo(currentUser.name);
      $('onboarding').classList.add('hidden');
      subscribeToList();
      loadOrCreateFamilyCode();
    });
  }

  function showOnboarding() {
    $('onboarding').classList.remove('hidden');
    $('lang-step').style.display = 'block';
    $('setup-step').style.display = 'none';
    $('ob-error').style.display = 'none';
  }

  function setLang(lang) {
    currentLang = lang;
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.lang === lang);
    });
    applyTranslations();
  }

  window.addEventListener('DOMContentLoaded', () => {
    const input = $('item-input');
    const addBtn = $('add-btn');

    input.addEventListener('input', () => {
      updateAddButtonState();
      if (autoAddTimer) clearTimeout(autoAddTimer);
      if (input.value.trim().length > 0) {
        autoAddTimer = setTimeout(autoAddFromInput, 5000);
      }
    });

    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        autoAddFromInput();
      }
    });

    addBtn.addEventListener('click', () => {
      autoAddFromInput();
    });

    $('clear-bought-btn').addEventListener('click', clearBought);
    $('clear-all-btn').addEventListener('click', clearAll);

    // –§–ª–∞–≥–∏ –≤—ã–±–æ—Ä–∞ —è–∑—ã–∫–∞
    document.querySelectorAll('.flag-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.flag-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const lang = btn.dataset.lang;
        currentLang = lang;
        setLang(lang);
        $('lang-step').style.display = 'none';
        $('setup-step').style.display = 'block';
      });
    });

    // –ö–Ω–æ–ø–∫–∏ —è–∑—ã–∫–∞ –Ω–∞ –≤—Ç–æ—Ä–æ–º —à–∞–≥–µ
    document.querySelectorAll('.lang-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        setLang(btn.dataset.lang);
      });
    });

    // —Ä–µ–∂–∏–º —Å–µ–º—å–∏
    const codeInput = $('ob-family-code');
    document.querySelectorAll('input[name="family-mode"]').forEach(radio => {
      radio.addEventListener('change', () => {
        if (radio.value === 'join' && radio.checked) {
          codeInput.style.display = 'block';
        } else if (radio.value === 'create' && radio.checked) {
          codeInput.style.display = 'none';
        }
      });
    });

    $('ob-continue').addEventListener('click', () => {
      const dict = translations[currentLang] || translations.en;
      const name = $('ob-name').value.trim();
      if (!name) {
        $('ob-error').textContent = dict.errorNameRequired;
        $('ob-error').style.display = 'block';
        return;
      }
      const mode = document.querySelector('input[name="family-mode"]:checked').value;
      const isJoin = mode === 'join';
      let code = $('ob-family-code').value.trim().toUpperCase();

      let userId = localStorage.getItem(USER_ID_KEY);
      if (!userId) {
        userId = randomId('u_');
        localStorage.setItem(USER_ID_KEY, userId);
      }

      if (isJoin && !code) {
        $('ob-error').textContent = dict.errorFamilyCodeNotFound;
        $('ob-error').style.display = 'block';
        return;
      }

      if (isJoin) {
        db.ref('familyCodes/' + code).once('value').then(snap => {
          if (!snap.exists()) {
            $('ob-error').textContent = dict.errorFamilyCodeNotFound;
            $('ob-error').style.display = 'block';
            return;
          }
          const familyId = snap.val();
          const userData = {
            name,
            language: currentLang,
            familyId,
            createdAt: Date.now()
          };
          db.ref('users/' + userId).set(userData).then(() => {
            currentUser = { id: userId, ...userData };
            applyTranslations();
            $('user-info').textContent = (translations[currentLang] || translations.en).userInfo(currentUser.name);
            $('onboarding').classList.add('hidden');
            subscribeToList();
            db.ref('families/' + familyId + '/code').once('value').then(c => {
              currentFamilyCode = c.val() || code;
              showFamilyCode();
            });
          });
        });
      } else {
        const familyId = randomId('f_');
        const familyCode = generateFamilyCode();
        const userData = {
          name,
          language: currentLang,
          familyId,
          createdAt: Date.now()
        };

        const updates = {};
        updates['users/' + userId] = userData;
        updates['families/' + familyId] = {
          code: familyCode,
          ownerId: userId,
          createdAt: Date.now()
        };
        updates['familyCodes/' + familyCode] = familyId;

        db.ref().update(updates).then(() => {
          currentUser = { id: userId, ...userData };
          currentFamilyCode = familyCode;
          applyTranslations();
          $('user-info').textContent = (translations[currentLang] || translations.en).userInfo(currentUser.name);
          $('onboarding').classList.add('hidden');
          subscribeToList();
          showFamilyCode();
        });
      }
    });

    const storedUserId = localStorage.getItem(USER_ID_KEY);
    if (storedUserId) {
      initUserFromDb(storedUserId);
    } else {
      showOnboarding();
    }
  });
</script>
</body>
</html>

